#!/bin/bash
set -eu

if [ -z "$COMMIT_TAG" ]; then
  echo "Will only push tagged builds to dockerhub. Skipping."
  exit 0
fi

REPOSITORY=$1
IMAGE_TAG=$COMMIT_TAG_VERSION
IMAGE_COMMIT_URI=$ECR_DEPLOY_URL/$REPOSITORY:$COMMIT_HASH
IMAGE_DEPLOY_URI=aztecprotocol/$REPOSITORY:$IMAGE_TAG
IMAGE_LATEST_URI=aztecprotocol/$REPOSITORY:latest

# Check if it's a repo-specific tag
if [[ "$COMMIT_TAG" == *"/"* ]]; then
  REPO_NAME="${COMMIT_TAG%%/*}"
  COMMIT_TAG_VERSION="${COMMIT_TAG#*/}"
  echo "Tag was made for: $REPO_NAME"
  echo "Version: $COMMIT_TAG_VERSION"

    # Check if REPO_NAME is equal to REPOSITORY
  if [ "$REPO_NAME" != "$REPOSITORY" ]; then
    echo "REPO_NAME ($REPO_NAME) does not match REPOSITORY ($REPOSITORY). Exiting..."
    exit 1
  fi
else
  COMMIT_TAG_VERSION=$COMMIT_TAG
fi

# Check it's a valid semver.
VERSION=$(npx semver $COMMIT_TAG_VERSION)
if [ -z "$VERSION" ]; then
  echo "$COMMIT_TAG_VERSION is not a semantic version."
  exit 1
fi

echo "Deploying to dockerhub: $IMAGE_DEPLOY_URI"

# Login.
retry_10 ensure_repo $REPOSITORY $ECR_DEPLOY_REGION

# Pull image.
docker pull $IMAGE_COMMIT_URI

# Login to dockerhub.
echo "$DOCKERHUB_PASSWORD" | docker login -u aztecprotocolci --password-stdin

# Tag with commit tag
docker tag $IMAGE_COMMIT_URI $IMAGE_DEPLOY_URI
# Tag with :latest
docker tag $IMAGE_COMMIT_URI $IMAGE_LATEST_URI

# Push tagged image to dockerhub.
docker push $IMAGE_DEPLOY_URI
# Push :latest image to dockerhub
docker push $IMAGE_LATEST_URI
