opentelemetry-collector:
  mode: daemonset

  service:
    enabled: true

  image:
    repository: "otel/opentelemetry-collector-contrib"

  ports:
    otlp-http:
      enabled: true
      containerPort: 4318
      servicePort: 4318
      hostPort: 4318
      protocol: TCP
    metrics:
      enabled: true
      containerPort: 8888
      servicePort: 8888
      hostPort: 8888
      protocol: TCP

  presets:
    logsCollection:
      enabled: true
      includeCollectorLogs: true
    kubernetesAttributes:
      enabled: true
  config:
    exporters:
      otlphttp/logs:
        endpoint: http://metrics-loki.metrics:3100/otlp
      otlp/tempo:
        endpoint: http://metrics-tempo.metrics:4317
        tls:
          insecure: true
    extensions:
      health_check:
        endpoint: ${env:MY_POD_IP}:13133
    processors:
      batch: {}
    receivers:
      otlp:
        protocols:
          http:
            endpoint: ${env:MY_POD_IP}:4318
          grpc:
            endpoint: ${env:MY_POD_IP}:4317
    service:
      extensions: [health_check]
      telemetry:
        metrics:
          address: ${env:MY_POD_IP}:8888
      pipelines:
        logs:
          receivers:
            - otlp
          exporters:
            - otlphttp/logs
        traces:
          receivers:
            - otlp
          processors:
            - batch
          exporters:
            - otlp/tempo

# Enable and configure the Loki subchart
loki:
  deploymentMode: SingleBinary
  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: "filesystem"
    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: tsdb
          index:
            prefix: loki_index_
            period: 24h
          object_store: filesystem # we're storing on filesystem so there's no real persistence here.
          schema: v13
  singleBinary:
    replicas: 1
  read:
    replicas: 0
  backend:
    replicas: 0
  write:
    replicas: 0

# Enable and configure the Tempo subchart
tempo:
  minio:
    enabled: true
    mode: standalone
    rootUser: grafana-tempo
    rootPassword: supersecret
    buckets:
      # Default Tempo storage bucket
      - name: tempo-traces
        policy: none
        purge: false
  traces:
    otlp:
      grpc:
        enabled: true
      http:
        enabled: true
    zipkin:
      enabled: false
    jaeger:
      thriftHttp:
        enabled: false
    opencensus:
      enabled: false

# Enable and configure Grafana
grafana:
  global:
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Loki
            type: loki
            url: http://metrics-loki.metrics:3100
          - name: Tempo
            type: tempo
            url: http://metrics-tempo.metrics:3100
    dashboards:
      enabled: true
      default:
        aztec-dashboard:
          file: dashboards/aztec-dashboard-all-in-one.json
        tempo:
          gnetId: 10578
          revision: 1
          datasource: Tempo
