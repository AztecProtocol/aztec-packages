volumes:
  aztec_data:

services:
  aztec:
    image: aztecprotocol/aztec:${BUILD_TAG}
    command: start --node --archiver --sequencer
    environment:
      - ARCHIVER_POLLING_INTERVAL_MS=${ARCHIVER_POLLING_INTERVAL_MS}
      - AZTEC_EPOCH_DURATION=${AZTEC_EPOCH_DURATION}
      - AZTEC_EPOCH_PROOF_CLAIM_WINDOW_IN_L2_SLOTS=${AZTEC_EPOCH_PROOF_CLAIM_WINDOW_IN_L2_SLOTS}
      - AZTEC_PORT=${AZTEC_PORT}
      - AZTEC_SLOT_DURATION=${AZTEC_SLOT_DURATION}
      - BOOTSTRAP_NODES=${BOOTSTRAP_NODES}
      - COINBASE=${COINBASE}
      - COIN_ISSUER_CONTRACT_ADDRESS=${COIN_ISSUER_CONTRACT_ADDRESS}
      - DATA_DIRECTORY=${DATA_DIRECTORY}
      - DEBUG=${DEBUG}
      - ETHEREUM_HOST=${ETHEREUM_HOST}
      - ETHEREUM_SLOT_DURATION=${ETHEREUM_SLOT_DURATION}
      - FEE_JUICE_CONTRACT_ADDRESS=${FEE_JUICE_CONTRACT_ADDRESS}
      - FEE_JUICE_PORTAL_CONTRACT_ADDRESS=${FEE_JUICE_PORTAL_CONTRACT_ADDRESS}
      - GOVERNANCE_CONTRACT_ADDRESS=${GOVERNANCE_CONTRACT_ADDRESS}
      - GOVERNANCE_PROPOSER_CONTRACT_ADDRESS=${GOVERNANCE_PROPOSER_CONTRACT_ADDRESS}
      - INBOX_CONTRACT_ADDRESS=${INBOX_CONTRACT_ADDRESS}
      - L1_CHAIN_ID=${L1_CHAIN_ID}
      - L1_PRIVATE_KEY=${L1_PRIVATE_KEY}
      - LOG_LEVEL=${LOG_LEVEL}
      - OUTBOX_CONTRACT_ADDRESS=${OUTBOX_CONTRACT_ADDRESS}
      - P2P_ENABLED=${P2P_ENABLED}
      - PEER_ID_PRIVATE_KEY=${PEER_ID_PRIVATE_KEY}
      - P2P_TCP_ANNOUNCE_ADDR=${PUBLIC_IP}:${P2P_PORT}
      - P2P_TCP_LISTEN_ADDR=0.0.0.0:${P2P_PORT}
      - P2P_UDP_ANNOUNCE_ADDR=${PUBLIC_IP}:${P2P_PORT}
      - P2P_UDP_LISTEN_ADDR=0.0.0.0:${P2P_PORT}
      - PROVER_REAL_PROOFS=${PROVER_REAL_PROOFS}
      - PXE_PROVER_ENABLED=${PXE_PROVER_ENABLED}
      - REGISTRY_CONTRACT_ADDRESS=${REGISTRY_CONTRACT_ADDRESS}
      - REWARD_DISTRIBUTOR_CONTRACT_ADDRESS=${REWARD_DISTRIBUTOR_CONTRACT_ADDRESS}
      - ROLLUP_CONTRACT_ADDRESS=${ROLLUP_CONTRACT_ADDRESS}
      - SEQ_PUBLISHER_PRIVATE_KEY=${SEQ_PUBLISHER_PRIVATE_KEY}
      - VALIDATOR_DISABLED=${VALIDATOR_DISABLED}
      - VALIDATOR_PRIVATE_KEY=${VALIDATOR_PRIVATE_KEY}
    ports:
      - "${P2P_PORT}:${P2P_PORT}/tcp"
      - "${P2P_PORT}:${P2P_PORT}/udp"
      - "${AZTEC_PORT}:${AZTEC_PORT}"
    volumes:
      - aztec_data:${DATA_DIRECTORY}
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:${AZTEC_PORT}/status"]
      interval: 10s
      timeout: 10s
      retries: 6
      start_period: 120s
      start_interval: 5s