// SPDX-License-Identifier: UNLICENSED
pragma solidity >=0.8.18;

import {Test} from "forge-std/Test.sol";

import {Decoder} from "@aztec3/core/Decoder.sol";
import {Rollup} from "@aztec3/core/Rollup.sol";
import {DecoderHelper} from "./DecoderHelper.sol";

// Blocks generated using `l2-block-publisher.test.ts`
contract DecoderTest is Test {
  Rollup internal rollup;
  DecoderHelper internal helper;

  bytes block_1 =
    hex"000000010668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000002d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000082f8dc86ba80d8fcf491fb7a255f4163e4f9601d022ba0be35f13297531073fd80000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000012b36b22912aa963f143c490227bd21e7a44338026b2f6a389cb98e82167c3718000000012b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0283622796e1a2fa4718e254eb46d3f4287b05a5aaee35af02a54f2af8362f97000000101f99db4b9ffa5ab637607ad50c7d10ea3352a53478e14354355a02b6a87a7ab1000000181ba22861f1a04d910c399ce20125a7ef53c3a47e0f51fe1d2c179ea83b8da34e0000000415db3dd5c4e4589c0b7a5942f81c11548dda500600adefeb8c49d13481a88e24000000022309e4044d29f2906c728a7d19672aa7d80f3fbc289d4dd6fcab93f1e197b727000000020a20b604e286954cd8b1622dcbda5ef1c4ad6bfd80a81ad80dcff2f5080d5ba00000001000000000000000000000000000000000000000000000000000000000000001010000000000000000000000000000000000000000000000000000000000000102000000000000000000000000000000000000000000000000000000000000010300000000000000000000000000000000000000000000000000000000000001040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002010000000000000000000000000000000000000000000000000000000000000202000000000000000000000000000000000000000000000000000000000000020300000000000000000000000000000000000000000000000000000000000002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008010000000000000000000000000000000000000000000000000000000000000803000000000000000000000000000000000000000000000000000000000000080200000000000000000000000000000000000000000000000000000000000008040000000000000000000000000000000000000000000000000000000000000803000000000000000000000000000000000000000000000000000000000000080500000000000000000000000000000000000000000000000000000000000008040000000000000000000000000000000000000000000000000000000000000806000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000041b024f6e2e258ac4fa7b3a0d03f9fa242eee6d884ec85d0efd4beca26a88da2100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006010202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
  bytes block_2 =
    hex"000000020283622796e1a2fa4718e254eb46d3f4287b05a5aaee35af02a54f2af8362f97000000101f99db4b9ffa5ab637607ad50c7d10ea3352a53478e14354355a02b6a87a7ab1000000181ba22861f1a04d910c399ce20125a7ef53c3a47e0f51fe1d2c179ea83b8da34e0000000415db3dd5c4e4589c0b7a5942f81c11548dda500600adefeb8c49d13481a88e24000000022309e4044d29f2906c728a7d19672aa7d80f3fbc289d4dd6fcab93f1e197b727000000020a20b604e286954cd8b1622dcbda5ef1c4ad6bfd80a81ad80dcff2f5080d5ba0013ffea42e60a3be0af304384d83ad4411df13f66213997a7f0b7551e242f19d0000002001872181b5fe2c7ea15e1e72f5672bc777d61c807771ff7ae40c9b2aa816323500000028063d7b42d552599d3f3ff8fbc93e55484d49fc20dcc41940e3ebeaac4483a8ba0000000803b6339133ac1ca21463e1e3370ca136862bac1be49bdc6e1e69f73068a22ebe0000000316204b8532027613f551ad0530dc70c1c3be36fb7828a3a6539a100c57d25034000000030aa1281a92ab93a92ea1e45d49ce373a45fdb0b7a988416e63cd0728252a112a0000001000000000000000000000000000000000000000000000000000000000000001020000000000000000000000000000000000000000000000000000000000000103000000000000000000000000000000000000000000000000000000000000010400000000000000000000000000000000000000000000000000000000000001050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002020000000000000000000000000000000000000000000000000000000000000203000000000000000000000000000000000000000000000000000000000000020400000000000000000000000000000000000000000000000000000000000002050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000008020000000000000000000000000000000000000000000000000000000000000804000000000000000000000000000000000000000000000000000000000000080300000000000000000000000000000000000000000000000000000000000008050000000000000000000000000000000000000000000000000000000000000804000000000000000000000000000000000000000000000000000000000000080600000000000000000000000000000000000000000000000000000000000008050000000000000000000000000000000000000000000000000000000000000807000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042ddfdac63df2e340ea582ed2b6c9d23bf04f6e98c281c25c6dd7e87251185b3500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006020303030303030303030303030303030303030303000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

  bytes block_empty_1 =
    hex"000000010668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000002d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000082f8dc86ba80d8fcf491fb7a255f4163e4f9601d022ba0be35f13297531073fd80000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000012b36b22912aa963f143c490227bd21e7a44338026b2f6a389cb98e82167c3718000000012b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000102d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000182f8dc86ba80d8fcf491fb7a255f4163e4f9601d022ba0be35f13297531073fd800000004238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed0000000225d4ca531bca7d097a93bc47d7aa2c4dbcc8d0d5ecf4138849104e363eb52c03000000022b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

  bytes block_empty_2 =
    hex"000000020668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000102d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000182f8dc86ba80d8fcf491fb7a255f4163e4f9601d022ba0be35f13297531073fd800000004238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed0000000225d4ca531bca7d097a93bc47d7aa2c4dbcc8d0d5ecf4138849104e363eb52c03000000022b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000202d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000282f8dc86ba80d8fcf491fb7a255f4163e4f9601d022ba0be35f13297531073fd800000008236394e84a01824e286653b542a923474253251e86c118f02978d5714538236c000000030aaa66ea64a4b9493d7237d092f8276e31eb3f8b14ae5c5e0a91fa5627745a83000000032b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

  function setUp() public {
    rollup = new Rollup();
    helper = new DecoderHelper();
  }

  function testEmptyBlocks() public {
    {
      bytes32 diffRoot = helper.computeDiffRoot(block_empty_1);
      assertEq(
        0x84036b397b37b2dab7c2d95581275797c8d06b432f3826ada23cca6d87d49b84,
        diffRoot,
        "Invalid diff root"
      );

      (
        uint256 l2BlockNumber,
        bytes32 startStateHash,
        bytes32 endStateHash,
        bytes32 publicInputsHash
      ) = helper.decode(block_empty_1);

      assertEq(l2BlockNumber, 1, "Invalid block number");
      assertEq(
        startStateHash,
        0xc3c559a71e6e4e6120dc290ac2aefe6739be32216168d5c98899a86f1566d930,
        "Invalid start state hash"
      );
      assertEq(
        endStateHash,
        0x448312391a3205ecaf22d804a780c19890d6425c621e9a731c342f9903a5e71f,
        "Invalid end state hash"
      );
      assertEq(
        publicInputsHash,
        0x2e8af2457a0c7cef1b1d47efa0583f1e0840910ab1a802bff812bbc5e62b7321,
        "Invalid public input hash"
      );

      rollup.process(bytes(""), block_empty_1);

      assertEq(rollup.rollupStateHash(), endStateHash, "Invalid rollup state hash");
    }

    {
      bytes32 diffRoot = helper.computeDiffRoot(block_empty_2);
      assertEq(
        0x84036b397b37b2dab7c2d95581275797c8d06b432f3826ada23cca6d87d49b84,
        diffRoot,
        "Invalid diff root"
      );

      (
        uint256 l2BlockNumber,
        bytes32 startStateHash,
        bytes32 endStateHash,
        bytes32 publicInputsHash
      ) = helper.decode(block_empty_2);

      assertEq(l2BlockNumber, 2, "Invalid block number");
      assertEq(
        startStateHash,
        0x448312391a3205ecaf22d804a780c19890d6425c621e9a731c342f9903a5e71f,
        "Invalid start state hash"
      );
      assertEq(
        endStateHash,
        0x2fb8f70b8011dfa8111055c18a0068294d795c2c82701f18b5bf93b3156fe83f,
        "Invalid end state hash"
      );
      assertEq(
        publicInputsHash,
        0x0b0c644c9a7106d293ca833a1cb332a576de6971951c2167408545dd7e31a7bb,
        "Invalid public input hash"
      );

      rollup.process(bytes(""), block_empty_2);

      assertEq(rollup.rollupStateHash(), endStateHash, "Invalid rollup state hash");
    }
  }

  function testNonEmptyBlocks() public {
    {
      bytes32 diffRoot = helper.computeDiffRoot(block_1);
      assertEq(
        0x05ab40c0ddda5b1846c6283c0a99ea7da9ebb3ea46f33225e72e0d0333bf251f,
        diffRoot,
        "Invalid diff root block 1"
      );

      (
        uint256 l2BlockNumber,
        bytes32 startStateHash,
        bytes32 endStateHash,
        bytes32 publicInputsHash
      ) = helper.decode(block_1);

      assertEq(l2BlockNumber, 1, "Invalid block number");
      assertEq(
        startStateHash,
        0xc3c559a71e6e4e6120dc290ac2aefe6739be32216168d5c98899a86f1566d930,
        "Invalid start state hash block 1"
      );
      assertEq(
        endStateHash,
        0x45faded932e3a828a426370bd7275120c3f4ed27117a6c98c9c762e8b8cec9f6,
        "Invalid end state hash block 1"
      );
      assertEq(
        publicInputsHash,
        0x28b90cb81b273c3ee583750e79bca15e9b01fe01a7eacacf462ee866cefb904a,
        "Invalid public input hash block 1"
      );

      rollup.process(bytes(""), block_1);

      assertEq(rollup.rollupStateHash(), endStateHash, "Invalid rollup state hash block 1");
    }

    {
      bytes32 diffRoot = helper.computeDiffRoot(block_2);
      assertEq(
        0x04a10b2ce6eb66a3ae547efacc53760ec64fb86c901f9cadb36c104cc532cb99,
        diffRoot,
        "Invalid diff root block 2"
      );

      (
        uint256 l2BlockNumber,
        bytes32 startStateHash,
        bytes32 endStateHash,
        bytes32 publicInputsHash
      ) = helper.decode(block_2);

      assertEq(l2BlockNumber, 2, "Invalid block number");
      assertEq(
        startStateHash,
        0x45faded932e3a828a426370bd7275120c3f4ed27117a6c98c9c762e8b8cec9f6,
        "Invalid start state hash block 2"
      );
      assertEq(
        endStateHash,
        0x0b04cfd8792e17a123c3c5c82bd2593e8da745d05296d4e1058708e11489909a,
        "Invalid end state hash block 2"
      );
      assertEq(
        publicInputsHash,
        0x04f8878ba2e56773029c2b246d41f04963cc8b2654bc35a66b72ff79a7a756ec,
        "Invalid public input hash block 2"
      );

      rollup.process(bytes(""), block_2);

      assertEq(rollup.rollupStateHash(), endStateHash, "Invalid rollup state hash");
    }
  }

  bytes shit_block =
    hex"0000002a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001f65b4074359ee6099d0bbe6f1c98e5f5318d1c35e64a19b00857f4a884507800000000000000000000000000000000000000000000000000000000000000010000000100000000000000000000000000000000000000000000000000000000000000010000000100000000000000000000000000000000000000000000000000000000000000004000000040000000000000000000000000000000000000000000000000000000000000001000000010000000000000000000000000000000000000000000000000000000000000001000000011e66dfd4dabaedfaf1e8090bb9023fba2ec1a7f0c0a70f3d79d14edff9a177a3000000102b4d078bae9ba1f227c34659e30fb2764dc42e102329c305dfe1c71b8b13c3e8218efc67133a35c67b24616db682472cad392d9d4476242d8ee6750277bbffe108a959230cb07c76ce451677baccb81357c76cc3bee9c01aab7f213546e15bee06984a0dabcc37447c3dbe110401f0dcc7223d7ed71d28bf560b1dd660bbb1b30b5af8322adb7aaa9000e3a02d00f03e5f52101a89bbcb90b316a18070476bf20b509a18bd20a2831f3636feea46cb9262c0d9cc6d1142dc13117454f5c502961f3faa67dd72995ffd84809593b993cbc42917d55ba0d28c4fc521a687cf3612125b1593ce18abc62586d3a135a8bec1ac3dbe6bfeaa11605cf6ef83f9450d320be6a4f46b18a9e3ef991cc18e4d30ea7348eb4d6466d0d1a5fb1394b1981df507e638344d2da317592c59a38a282723264b4ce6c4e9d9beca157ea384d1dc8c0d6806130a84cb3c4c35ef02dadd1bf5952cdb3653965f6fe65595cd5cb592ea0d0ebaf35c51b06c1e2173c0a6e3d639c7e342af3a6ca683997f083ea2fd9cc7025dc0a65941ae32a3be072f7639795c30895ad9705b84da16a4c88730aadeb227a4490a38b26b36af46da12afd3e87854e3e577a8ccc0136077aec2da90a128168b6eee3bea49d0d79c8b939154825072b9c88465c50a503cf8a0026334818b09fe6f5c251805de69da4792dfa2181d55a92e2f408b6c5b9471b30d37010c8900000010071eae79e67df2f9da54f3c048fb8797e2484a18a6db1195dbc07a0cd104f43810f2f450f845188b6ce31d8134449ee0610ee7a813c6e835f59e96fa4a23d73a296f1c1125e8f017d61d9cb915231ee1f043c78702b1d33610a10c27a7c2b8620e77199b7b44a1e7b023b353b7dfee8766295f5a77c002be06b263ad46da2856255feef64cdba9c4d72821a61871a60a22e619a01ad8ca72da9bc730f6e945da05172947e3da2fee75befd0a30dd7ffd17b247bee37ee84f5f5901df45c2b6d1030e7c20f1913927b787e8b3aaacbe11390b6aaa1863ad0d09d529b000d59226257642e5edeb5db719c44101e40937fed85cfd776b5a1ec33205e256adadbf170c68d56feef6e33cc31d22401bf09537bb6186569367edcc1d3aa7da73b3473f002d294abbd6196af4f6bca3a4074b7f4d2f7edff249a76dafc41e6f615b66ed272f22767a099c48f88a17ff7c7fa241f033b06e5e24d7a834034443763efce81a246d243a5c4bdc3db65585a3c6650131a25813fb8c96395d143f49fd7d591e17f1e9dcffb1b1279f557530bc7d0bd6e7c4e4efae90a80f30f9c5589068bbed0620fd418c5feecab1f1ebe01204c89ce0cefa4160da28abf007c7d53195d29704c6bbfe99cee495d10802653d2c42bb4c5f2c64c83e95791abfbdc4378603412cd57ac5e01295e0ef51f498a43c9a51bac06f937ecc422de4ddd8af4633748700000010215d38dda4947b8f103900dd33ae5ac357aec2fa2a68cc68b8f57f47efa0752a278aa25dd6cedae52ba05413b10a31e687c75709ee8e1f7f8bb206c182332b661180ec4b012f17d435a4ad8800ab6e357ea1654aa860190d0b61b3601cdc23d914d0670515007aaf1548346840ab8ba56f6ab631a90e514001a792ed2a164d642947967d33b936b55d7e78c31633ec2aec8ff35f470de92fafa084cc69ae181f24521149c164a4da885086da02eacf444ba97806ca2ad83166c5e1d8bbb2ed3025d35e9949ca4914948305786c771fb6061947f09e42e31322eb5866732031702cc02a5feaf07e64e2279c742eadcf583441aee621c9453b480b3695bfb9d5e22ed22c66a922ecb174ca97c206558854066cf9c19fef8a011576ba51f4c7be31237ba9ee9737f7e8938c5f2e50b7ce21268f18636c6e90e9794f7348b3ce38762576c485a3be51f9ecf98a454d7e89ff9fe944cf2b1ee00a7a37aa96705e95e4121326b5cfa197eb251483287a508703186689d284bb2f3f8a0b6e0627cf04ea09eea4080c5965bccac7007f56f0d0830becc244e3f6358a9c4dff8003c58f1a19cbb01884fcdbc1dcb492b2e236fe4c13a2b200d49fb9191ff597debeb3c3fc1837a8d6afc24a1e73b6e051df69f2f97ebaed9e8698725f1aff99c169dfe3bc1dd9d5875364433396c38c7b7106f6d500a9659ddec7b2b7199b5095c5b7e4d80c6c4a0a07635a9a145d4caaf3ea7556e047278491fbc8920e10a1eb5aca502c1bd56945653dd238796fc2636837e2c666f1f6b3b1fb0416b4d11a6b13085b55135bf7b55cf7ea8aaee7c1a9fe19a8c8c5b67eee75d7c89abc39e72e6640d03b2345a21976832833874e8be3a52a785952a64300d114eb4ed91bcbb8e1dfbd7f0b35dd47b0b0e310743f5cff85f269d67e07c097c4f86d7b68f04eb15315d20f17af9108d6d93c4ea9110d6ccdebc47128e8f6646e7071f790a1de96570684f812056abd76bdf931ea1b98d594e5a2852c1c0faad438b0c990efe6a4cee8e5521dd2db6fd8f1b3967b1f23393708c2c9cdcb69676701784757d992250b77195e20a7738bd5d803e5816c05970aeb94a8c0dc4d4cc5fd2c6c6f2cdf4ff8eb3fd02973568253d44796048c4eba0ed5ad38489bcc8c688e9bae9dfea78727bd52a51905719c95fefa231186bc6192ee93212f60e8e05711b9c429627932fc9e3ec506518e90ef39ff540c33446547232d4753eb6ec7370dd030fb780788e86edca72e45d9c2f593a38e85cd20f99ba41a58c8f8eea72dc88607c6e1d16948296b8b1ca0d082aac59afe0d86afbbbcca07121143dbd257dfe031db2c40e63ae623462d279f76cbd462b1910ffb6d01ad67bad8c59c420b45ce9cb7ba16bff9cb3bbd1b25bcd157a4c3a3e9b3ad1650c0b36528b4e52860e9017c45709d44ccbb8f4d000000041e9e463883f337360468f7814c05e5b180eb18bdee9cf1d025f07bccee6cad55222402d92dc2b336fbedca3235b1ae6d75ba80e48cf3f1bd65168e2f26e78bdd01ca5f5bca15d11439b8fbfae6ac36f43ae83921898729fdc2fdcfbe6fd58e632fc1c8f8e3e8840c9cae9738eecf3ab37649689a1a9324417f4d5e7578849359280d7c5763dc66441bd3e80e6ed0722dac8bc1d5836052b3f14ebf99af146febe19ab490c8aa23fbbd53d300419aca8247aaa4e3267f4a87be4265bca813bc606ea2545ad7e96ca022ded7b7fd5d6f227bc71530d9e8ca442c578b77101f66d782297946b3170bff2c4ddcfba1f8cbdebcb9ab69792f41a01a7301e0168fe012cccbf95e2adee7e7e5f8fb980dd1c437f5df1a4eedf3b90fdc94d16b03473636405072676a54b220fa61c66e2d05450160a9a6a126ed95bc58030b91204fe1d73b47a17146e45271de3bed6d47ba6b75";
}
