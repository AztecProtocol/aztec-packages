// SPDX-License-Identifier: Apache-2.0
// Copyright 2023 Aztec Labs.
pragma solidity >=0.8.18;

import {Test} from "forge-std/Test.sol";

import {Hash} from "@aztec/core/libraries/Hash.sol";
import {Constants} from "@aztec/core/libraries/Constants.sol";
import {DataStructures} from "@aztec/core/libraries/DataStructures.sol";
import {DecoderHelper} from "./DecoderHelper.sol";
import {Registry} from "@aztec/core/messagebridge/Registry.sol";
import {Inbox} from "@aztec/core/messagebridge/Inbox.sol";
import {Outbox} from "@aztec/core/messagebridge/Outbox.sol";
import {Rollup} from "@aztec/core/Rollup.sol";

/**
 * Blocks are generated using the `integration_l1_publisher.test.ts` tests.
 * Main use of these test is shorter cycles when updating the decoder contract.
 */
contract DecoderTest is Test {
  DecoderHelper internal helper;
  Registry internal registry;
  Inbox internal inbox;
  Outbox internal outbox;
  Rollup internal rollup;

  bytes internal block_empty_1 =
    hex"0000000000000000000000000000000000000000000000000000000000007a690000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000002d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000080668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb6710000000119c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000012b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000010668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000102d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000180668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e1500000004238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed00000002238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed000000022b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e1500000010238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed00000002000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000001000000000000000000000000000000000";

  bytes internal block_mixed_1 =
    hex"0000000000000000000000000000000000000000000000000000000000007a690000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000002d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000080668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb6710000000119c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000012b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000010813349a787d3f13ec3492de8b6a5c06ba871cb7d2533b8859f3c40693384501000000102e18315fa9fc796d3a94dfe61517725dec4e9d0811ce7e8ee3518cdbcf03549d000000181578dee3629aa301b877887a478484ab676934bd9f8228be7c5cdb5873f975580000000412e58befb4676abe3a279ec129e4d48b53eb1b1724a6c01274b39f6122dfc0bf00000002091367641fbcfd08d2b16d6ec75bb365bd807a436fce9163516a1de3532e8de3000000022d9b8d2353587ca56bdf967b4bb8847af3671bd6901e9e28f82c240c6e33129a1b3ab03f9b9fb0f8a31ed10a930e476c7b8bfcc9018d6dfbe20eb15838a701e9000000103036ed03e75f4893197d647af9e8f5dae3659ac9003c6b144dbb86b71820307400000002000000100000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000012100000000000000000000000000000000000000000000000000000000000001220000000000000000000000000000000000000000000000000000000000000123000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001410000000000000000000000000000000000000000000000000000000000000142000000000000000000000000000000000000000000000000000000000000014300000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000161000000000000000000000000000000000000000000000000000000000000016200000000000000000000000000000000000000000000000000000000000001630000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000018100000000000000000000000000000000000000000000000000000000000001820000000000000000000000000000000000000000000000000000000000000183000000100000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000022100000000000000000000000000000000000000000000000000000000000002220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002410000000000000000000000000000000000000000000000000000000000000242000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000261000000000000000000000000000000000000000000000000000000000000026200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000028100000000000000000000000000000000000000000000000000000000000002820000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000520000000000000000000000000000000000000000000000000000000000000052a0000000000000000000000000000000000000000000000000000000000000521000000000000000000000000000000000000000000000000000000000000052b0000000000000000000000000000000000000000000000000000000000000522000000000000000000000000000000000000000000000000000000000000052c0000000000000000000000000000000000000000000000000000000000000523000000000000000000000000000000000000000000000000000000000000052d0000000000000000000000000000000000000000000000000000000000000540000000000000000000000000000000000000000000000000000000000000054a0000000000000000000000000000000000000000000000000000000000000541000000000000000000000000000000000000000000000000000000000000054b0000000000000000000000000000000000000000000000000000000000000542000000000000000000000000000000000000000000000000000000000000054c0000000000000000000000000000000000000000000000000000000000000543000000000000000000000000000000000000000000000000000000000000054d0000000000000000000000000000000000000000000000000000000000000560000000000000000000000000000000000000000000000000000000000000056a0000000000000000000000000000000000000000000000000000000000000561000000000000000000000000000000000000000000000000000000000000056b0000000000000000000000000000000000000000000000000000000000000562000000000000000000000000000000000000000000000000000000000000056c0000000000000000000000000000000000000000000000000000000000000563000000000000000000000000000000000000000000000000000000000000056d0000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000058a0000000000000000000000000000000000000000000000000000000000000581000000000000000000000000000000000000000000000000000000000000058b0000000000000000000000000000000000000000000000000000000000000582000000000000000000000000000000000000000000000000000000000000058c0000000000000000000000000000000000000000000000000000000000000583000000000000000000000000000000000000000000000000000000000000058d00000008000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000003210000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000034100000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000361000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000003810000000426fcb9639d15aabe6d792e23ab12fb9633046d4be6911a60d64471d7560d3f6809143b7d4943a3485115d37e7596938a16c91b6055f3837640d8c36b8303bb3c06fb5fb553496e5e0b48834087e036acf99d6d935dc2ebf43c82788cb5ed1c6a2f4bd77ac2bb5474d48c2856135d18168cd6f69f77143c60b3cc370319419dac0000000000000000000000000000000000000000000000000000000000001020212121212121212121212121212121212121212100000000000000000000000000000000000000000000000000000000000010404141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000106061616161616161616161616161616161616161610000000000000000000000000000000000000000000000000000000000001080818181818181818181818181818181818181818100000010151de48ca3efbae39f180fe00b8f472ec9f25be10b4f283a87c6d7839353703914c2ea9dedf77698d4afe23bc663263eed0bf9aa3a8b17d9b74812f185610f9e1570cc6641699e3ae87fa258d80a6d853f7b8ccb211dc244d017e2ca6530f8a12806c860af67e9cd50000378411b8c4c4db172ceb2daa862b259b689ccbdc1e005f140c7c95624c8006774279a01ec1ea88617999e4fe6997b6576c4e1c7395a22048b96b586596bd740d0402e15f5577f7ceb5496b65aafc6d89d7c3b34924b0c3f2d50d16279970d682cada30bfa6b29bc0bac0ee2389f6a0444853eccaa932b2a60561da46a58569d71044a84c639e7f88429826e5622581536eb906d9cdd25a2c0a76f7da6924e10751c755227d2535f4ad258b984e78f9f452a853c52300e212d8e2069e4254d81af07744bcbb81121a38f0e2dbed69a523d3fbf85b75c287ca6f33aadbac2e4f058e05924c140d7895a6ed167caf804b710d2ae3ba62b1b51297b3ea37637af6bd56cf33425d95cc5c96e9c2ee3077322fbec86a0c7f32c15d2a888c6cc122e99478c92470a1311635142d82ad7ae67410beeef4ae31f0902ba2fb964922a4610bb18901f7b923885c1d034da5769a48203ae6f0206a92855e2c01ddb3d6553386b5580d681b8230fa4062948668f834f23e0636eaff70aaa64519aafdf4b040bd2f9836e76b9dc13cfec8065dcdf2834d786e06260d100000e1000000380000001bc00000090ec99a4297db39688e2322331abb78419ee5d2a0f12c2860be5b8ed79173d55b428e72cce6f6b1dfc9bb8bc110ad5bef73cdfd791c0764adbe23349911b8f9ac51404d51d4e854961d802b876318444d7b6a2821b207fb6009b38922b0ba1a405b4b45b105dee6828374f63ac54307d669be1dbced8b18d9e6cb6b824ced80735789e2535353b45847445d29af890e8640000009049378a7d2e1c5dcd44b267c11921d93f3eabf9eda668326b3f041d79dea2ac63df7d5e0e14c8ad0f6e953c5f8001738feb80f69a4a7330a14b97fc4394bf28c9af9778f981208f77209504121e72c7fbbf18ca14e2f552268f6ea44d92c94ade0e7a99f869594dcd297ae50a047a51fae01c2f0c17115025b1fe92bdf30673bb60863f2e8995c3ac2bcf6c69a1ad9d9e00000090f133c0763d7182c7017b803f33907ee61fb80b2fe07a88b9ad2a019d00409d1cc155e97591393d56ac25740d92abefa2da66759402b6916c7bb499017d2b8ba06ef74c9d70a7df1a085b0991e252fa17a76bc5cfc6aada1b2e810516e9c99507b309da5b4c27fe87f8dbfb0a49de33144d52ff9095202e1945713fd046f208022bf80f7130de3e6ad4d595763cd8dbf7000001bc0000009059505845d53379dfb44b8ec4637f841b9ea59481db628325a2890020b18298598b4688cb97fe87df3b63a7b8fef33a67739e678865d5ce2699ba3317af4691853ac1839f0a23c6468efa5ff4cfc407b1c7d5676b4bc3e8ab7b06935c77199756f9fa5c460ae068981862611d667e08aa696b368c0ace843cc9520dd625712c0f2ffcc9d046c7fb9f5be672ab54f1be1b00000090e2c59ac10ed5290db9369a87ccfa6c939066aae2657a9871b3912320e8036da92618419fd9a3b113915bee24fc82b05143a9dee0a5fc08f0a04a191faf99e6ade2cfee73240861a9b3c45fcf084d2fd20ec363766d894d2cf9220adb3c797465b4430b84cce45ff2d41a587115260d626de13cab9ca4ba62011c8d451938ae08c37ed1ba9d2b48a9b7a7439d37b8994900000090836e89a37e4fb76dbac5c4746c77dffbd39ba305657e3da07f686f18bc9588adf1c027cec2a40e01ef51ac9632ff6313893ef56ca4c4d9ef6e1f8a7662d6787d56fa3efa0b3dbcc45ca24056e2e590861c8953dd5d549868f8e36c4285f88ff2c44888b7d5994aad6261bf441c912b5d36be9d2ac0391647bf1a5ec3520a5ef6c0278638d45d0d4a4f7ff70f1471563f00000380000001bc00000090ce1161a8ad29de75f5fba4d9f371032f48bb2b215d8725f223cfdb38e57de2f8328d9fe32a03ba61c6403079793e7365c3ced6469436276dfc18f9b8590c6cab54cbbb4cb30267713f0712550a9be2ab7355f772c656302c56062738b906ceaa6790456755b71da30eb5ea050809bade5ef7cdd7f7108466f547311be3718a11434289a2bd87f4025534b61c8d8fe06e00000090570a4c5ab142b8469a8ee681ff561d4a8da16bc9665101f448042393b103770db8570c309547889f46904e05d8aaf79b083e47117c4b59869330943f818d237af92ca36e51b90b0263bcae7e0923307b444e6e20b25d7f085b2e779bed1177b2fcbb796953b9436c955719ca155e22950c989a61f9eb8be6690127fb7c0e2d594df7d50693cc37a912ef64b19a0d927800000090a532abc547289039a776ee2e0ecbec5f4226c4c00b48d8929bfcf3e94bcc9934d7923824af60374e22cfdd3af2459976bfd9fb129b732bc904abaedf7e132b64501c4eea8d4b35e18ca4afa155b39fe45e67c023ea1b6993f9ba7e3e0c4ba40b58b060c23ad7f3056c4d3dcc8718ed5f547b5487360d57a845ebd64d8d36385a5b0af765d8f525bef94ad3d33497af84000001bc00000090d5c264ecf0f6a309bec7a2c5f60fa79736f38fbb809a742ea6b6448d0b6ffde682b317d1ece0c768a5e6904dfb87d69188b6b3bcb2fad8905804561af109b9652267d377049640ebbab4ac89e514dd742d4528767801805e350ac958d1dff6697a873d3185ea833cc1fee542ecd0203bd72ffb136ce6eec23964186818d96e60752e2fb6f9eaa155a7b35f35f81f466f00000090eb790262cd55007faeb8e30b6f1012ba3240f9120bf2afbf8debc873e8ec8c6869e944b53ea32aa7e3e03cb4708eb76c2ef8d1edc8b4661e74bf99b7088891bcde5ac998b5c640f835553a407d9215be8fb720e0759119cdadadc591a523193f035e6687565a8e637a694556b867bb9e2a9d2bff45fdeb531ab7d0e94c7a6f4114a5767215d3142d067a65e5331caa9700000090fa611c6bb845db2dabed7a929f2e04850ed5759a934a6905a01b0fc757475a2a1b767d3788dfc78e7e80fe72e96dda1d74b0fe4819c00353b05341e4a37323021751caace45f7af9761a91cdbd29974977161107b3e7ccbc09b8b592329b3167a03d5c7acfef6d09a776110921c2d7b615dbf650e8147b6c1b4bdcc07c0db7939b8a5eb076baae5ee2d00cb9b6d8919700000380000001bc00000090744951715ee6e94eb1b539cba72ac09a382943ffa46d5617014dcf8faa4fb8baca118ad6878d7fc711c3f8bc94658e08fde7a06dbfaa54191cac9135f6e474413471381999c84f4b7ebbff80732d37fa125001a3edc40bd1c3fccd1d2dafbcfa3e477a091734e110a04c86fc5f67771349670a81029278111c5823c07ae84d22b35daa8f79e3cac496ee4c123b8f288300000090111784ad011f1cb2e0ad95ccc3471bfcbfee8fc9862b4e7d23cdd7c8d225e9079c9038570c84f086b0e3a2a31ad84e6bbe4caf261fdd9141dae4dcd55c9fb30939e68f6bee515d1de85d66acc3995b6404dda6d91ab5d0817cb500e0482f90a290b95d942a6cd2c97a077c6b918456db8f2d7549be7ea206c542b5f0dec5aae0788516186336ab2a86bc4efd71a3d0d90000009095461ba87a211e219ba880ed613566e168967319f42e9249517569ec81fd84e8b0a81293522facfd5a34d435a120644e03ef539e71be0be06f741e4ee3ad216dbec4458cd54694b26cb2ccaa0f1224c4687c484f77403f01c2698618d8784692487d36f13315d83ddf48f8378826e8a092efe0b84cd87313d1326090a0e610d6025ec5484928fa596442096d921c053f000001bc00000090473c327f0291c78a9d6f2c2c08a1523219565af5dfef7f7c1a0b495c1070195b540f5c9b7f97feff45064b30f4534fb8ca51c5dd911f6b6e815e69d095762c60218b47823c164119c1e4f0c4be95fbe04336158adcf1018079fc6425bb1897634147f12552f4d1896e7f68c8058d2bf66972d462212075834e3022100d5c574da048289badd816555a77a00fa0ca9f430000009042c807c7a42be7e97da4d5977eb0d170735abe5264d00380cb04d046ece0e31e67bb94ed03bd026be928e97e52e2a62faa49dd3d89b379f18c8a92635b30a8eb0f9b1268348f7140ef4c9cdee172a65f89473aea5429f542c3e8b3aa087ccbe0f9466108348e3635c21303deecc385ea313c977a55c05344470990534692cd77726308947960f70544b0a12cfb345c49000000900e495dcafdcf5c633be211ac9bfa0175c5708497ab90b432778c11d113ad1084c68e90a264810bc72d317119ea8ee71257d7c272d0a722a1e0d068f41a15d52b3126d912d89f74edf0871056cda9d44f7025066257eb8641b874dad5940e4978082982bf96645edf1266595e02e437c2bb53f0d3592eaf13305dec70264d007f817b424021ae673cd4de7f1fc7466f0a00000380000001bc0000009066b9a3db0200dea6c78710956414411cafa6516740f32f378790170968246fe3912d37e7f46e04415318bce1ff2beff8dbf24c3f842401ec39529903da13eafeb0092fd75f78d901a870b5fa8543e2020a30310d6bb75308ab9b79dbb6840aad9d6ab49aa20ab18f81d7cece41e4b96a3153abedc43792f7218d0d5051f36a74b1ce29d49a6e505b2ad598357705aa880000009008e25e0dfda006fa3be4ff0b833903de79777ad5498604aeb4f7c0f9a11dd8620c64e99789f336d41e15190c1a0b39f929bf4e6b252d7c17b3a4c998103efa26ec7d4acc8c236300ea8e7069822e71715aaadc3ec1190a8be5e1cc9dd836ebc1ee7f7c942be344030228997d8827861ed4b25169bde6bf3fc622ba55b031bfe6377faa336d493d7c483c853ad5bceac300000090b7e7171397531d89d6581e1b44099a7905d946c834484c9227f710bddcdb3b3538612da5b3634c9d13f5fecc94dca34f95bf282ab3a8da16631668014c303dd5c8aa18993133f7cfb818b763b063888f70c2c32c0ee86b5ac451f01f85d47e3bdbd1930a5088f174769c136828e934a26466f145c0ff6392013f106b6b190013e8a79ccb06a243739b9d5009dfab446f000001bc00000090553286b3e51fdcefbe970f077678f9bcf622591ab26d444c8dbe42b6423657409ba7188e6afc9966fb19d3cacb4240e4d2117d58cecb8923b8902b1d0d6cd22790303db046fd0ceefc67da538c031e9b5a52f71e9a4753f4e30a1c43de61461ef920b8554cf6dc74da7b917f0647f4e10204ac223b2991cd6552bf7a160a778da1442b12aa0244b716a38b685ca99cc10000009047c239dcf86d27be11a68316d60221314807be55610811c26c93483cf589fc5a3c473c13d8b6696a479c990f5c48b74e6385028fb411e04ee1c2c390057944d47e2b7b7bb8c5f266619b2bde6e0f1e716acf365b160ad460ad547faa61ff7a4d2e784ca00efc6ac63296313a7844e5b2ff95f8fe17abe2c255d4efbabee2257c677ef6a4811f30031cf4ce87241bacd20000009091a03340db588466f2e7ad22ed60ed52383387db254c24d7fc524bcaf92f5e0c75cf04d61893654c1d24c0ec16d933a53b8c80f1f07ee39c020b3b392f8a0bc2f62ca9532a16ba1a5de9ec25bff3850fb4518fdaef0ef79f5a6d32fcdd1dacdc7b41ea91fc0e02ccb796d65d5acba3eb25a1da00d0a8e7a85009b4cf8d638953caca6f7d92979ba01ba8a0b8ab901d04000000400000000c0000000000000000000000000000000c0000000000000000000000000000000c0000000000000000000000000000000c000000000000000000000000";

  function setUp() public virtual {
    helper = new DecoderHelper();

    registry = new Registry();
    inbox = new Inbox(address(registry));
    outbox = new Outbox(address(registry));
    rollup = new Rollup(registry);

    registry.upgrade(address(rollup), address(inbox), address(outbox));
  }

  function testEmptyBlock() public virtual {
    (bytes32 diffRoot, bytes32 l1ToL2MessagesHash) =
      helper.computeDiffRootAndMessagesHash(block_empty_1);
    assertEq(
      diffRoot,
      0x5839961bac64bb22cf48aaa99c963c37ec2168743fc4125b7aead2793d8dbde8,
      "Invalid diff root/calldata hash"
    );

    assertEq(
      l1ToL2MessagesHash,
      0x076a27c79e5ace2a3d47f9dd2e83e4ff6ea8872b3c2218f66c92b89b55f36560,
      "Invalid messages hash"
    );

    (
      uint256 l2BlockNumber,
      bytes32 startStateHash,
      bytes32 endStateHash,
      bytes32 publicInputsHash,
      bytes32[] memory l2ToL1Msgs,
      bytes32[] memory l1ToL2Msgs
    ) = helper.decode(block_empty_1);

    assertEq(l2BlockNumber, 1, "Invalid block number");
    assertEq(
      startStateHash,
      0x3f44449b8c2d3d36f6fe121c5d8d6961cd038fd4135fdf1ced70df6eb5f6ac26,
      "Invalid start state hash"
    );
    assertEq(
      endStateHash,
      0x4cd75162770eef80e2137e76268a02694251dab36637ff0932a29e81c9dd8c44,
      "Invalid end state hash"
    );
    assertEq(
      publicInputsHash,
      0x0dd3388aec6141b0153970eb5c65a52caee305ea245abff8aff45a37b16bbdb4,
      "Invalid public input hash"
    );

    for (uint256 i = 0; i < l2ToL1Msgs.length; i++) {
      assertEq(l2ToL1Msgs[i], bytes32(0), "Invalid l2ToL1Msgs");
    }
    for (uint256 i = 0; i < l1ToL2Msgs.length; i++) {
      assertEq(l1ToL2Msgs[i], bytes32(0), "Invalid l1ToL2Msgs");
    }
  }

  function testMixBlock() public virtual {
    (
      uint256 l2BlockNumber,
      bytes32 startStateHash,
      bytes32 endStateHash,
      bytes32 publicInputsHash,
      bytes32[] memory l2ToL1Msgs,
      bytes32[] memory l1ToL2Msgs
    ) = helper.decode(block_mixed_1);

    (bytes32 diffRoot, bytes32 l1ToL2MessagesHash) =
      helper.computeDiffRootAndMessagesHash(block_mixed_1);

    assertEq(l2BlockNumber, 1, "Invalid block number");
    assertEq(
      diffRoot,
      0x7c617860500c9b78729c91a3c38597c012efa9291146261bb4d07a5b6396d194,
      "Invalid diff root/calldata hash"
    );
    assertEq(
      l1ToL2MessagesHash,
      0xb213c9c543fce2a66720d26a913fe0d018f72a47ccfe698baafcf4cced343cfd,
      "Invalid messages hash"
    );
    assertEq(
      startStateHash,
      0x3f44449b8c2d3d36f6fe121c5d8d6961cd038fd4135fdf1ced70df6eb5f6ac26,
      "Invalid start state hash"
    );
    assertEq(
      endStateHash,
      0x1e54f0c574c9a0f80c56323046cd03448e26adf70184d04d44b58659e2828e56,
      "Invalid end state hash"
    );
    assertEq(
      publicInputsHash,
      0x28c8d8984fe7b4afb362af62d83b237d303f06dfc05ab37d3484b4d122a36376,
      "Invalid public input hash"
    );

    for (uint256 i = 0; i < l2ToL1Msgs.length; i++) {
      // recreate the value generated by `integration_l1_publisher.test.ts`.
      bytes32 expectedValue = bytes32(uint256(0x300 + 32 * (1 + i / 2) + i % 2));
      assertEq(l2ToL1Msgs[i], expectedValue, "Invalid l2ToL1Msgs");
    }
    bytes32[] memory expectedL1ToL2Msgs = _populateInbox();
    for (uint256 i = 0; i < l1ToL2Msgs.length; i++) {
      assertEq(l1ToL2Msgs[i], expectedL1ToL2Msgs[i], "Invalid l1ToL2Msgs");
    }
  }

  function testComputeKernelLogsIterationWithoutLogs() public {
    bytes memory kernelLogsLength = hex"00000004"; // 4 bytes containing value 4
    bytes memory iterationLogsLength = hex"00000000"; // 4 empty bytes indicating that length of this iteration's logs is 0
    bytes memory encodedLogs = abi.encodePacked(kernelLogsLength, iterationLogsLength);

    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    bytes32 kernelPublicInputsLogsHash = bytes32(0);
    bytes32 privateCircuitPublicInputsLogsHash = sha256(new bytes(0));

    bytes32 referenceLogsHash =
      sha256(abi.encodePacked(kernelPublicInputsLogsHash, privateCircuitPublicInputsLogsHash));

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHash, "Incorrect logs hash");
  }

  function testComputeKernelLogs1Iteration() public {
    // || K_LOGS_LEN | I1_LOGS_LEN | I1_LOGS ||
    // K_LOGS_LEN = 4 + 8 = 12 (hex"0000000c")
    // I1_LOGS_LEN = 8 (hex"00000008")
    // I1_LOGS = 8 bytes (hex"0000000493e78a70") // Note: 00000004 is the length of 1 log within function logs
    bytes memory firstFunctionCallLogs = hex"0000000493e78a70";
    // Prefix logs with length of kernel logs (12) and length of iteration 1 logs (8)
    bytes memory encodedLogs = abi.encodePacked(hex"0000000c00000008", firstFunctionCallLogs);
    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    // Zero because this is the first iteration
    bytes32 previousKernelPublicInputsLogsHash = bytes32(0);
    bytes32 privateCircuitPublicInputsLogsHashFirstCall = sha256(firstFunctionCallLogs);

    bytes32 referenceLogsHash = sha256(
      abi.encodePacked(
        previousKernelPublicInputsLogsHash, privateCircuitPublicInputsLogsHashFirstCall
      )
    );

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHash, "Incorrect logs hash");
  }

  function testComputeKernelLogs2Iterations() public {
    // || K_LOGS_LEN | I1_LOGS_LEN | I1_LOGS | I2_LOGS_LEN | I2_LOGS ||
    // K_LOGS_LEN = 4 + 8 + 4 + 20 = 36 (hex"00000024")
    // I1_LOGS_LEN = 8 (hex"00000008")
    // I1_LOGS = 8 random bytes (hex"0000000493e78a70")
    // I2_LOGS_LEN = 20 (hex"00000014")
    // I2_LOGS = 20 bytes (hex"0000001006a86173c86c6d3f108eefc36e7fb014")
    bytes memory firstFunctionCallLogs = hex"0000000493e78a70";
    bytes memory secondFunctionCallLogs = hex"0000001006a86173c86c6d3f108eefc36e7fb014";
    bytes memory encodedLogs = abi.encodePacked(
      hex"0000002400000008", firstFunctionCallLogs, hex"00000014", secondFunctionCallLogs
    );
    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    bytes32 referenceLogsHashFromIteration1 =
      sha256(abi.encodePacked(bytes32(0), sha256(firstFunctionCallLogs)));

    bytes32 privateCircuitPublicInputsLogsHashSecondCall = sha256(secondFunctionCallLogs);

    bytes32 referenceLogsHashFromIteration2 = sha256(
      abi.encodePacked(
        referenceLogsHashFromIteration1, privateCircuitPublicInputsLogsHashSecondCall
      )
    );

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHashFromIteration2, "Incorrect logs hash");
  }

  function testComputeKernelLogsMiddleIterationWithoutLogs() public {
    // || K_LOGS_LEN | I1_LOGS_LEN | I1_LOGS | I2_LOGS_LEN | I2_LOGS | I3_LOGS_LEN | I3_LOGS ||
    // K_LOGS_LEN = 4 + 8 + 4 + 0 + 4 + 20 = 40 (hex"00000028")
    // I1_LOGS_LEN = 8 (hex"00000008")
    // I1_LOGS = 8 random bytes (hex"0000000493e78a70")
    // I2_LOGS_LEN = 0 (hex"00000000")
    // I2_LOGS = 0 bytes (hex"")
    // I3_LOGS_LEN = 20 (hex"00000014")
    // I3_LOGS = 20 random bytes (hex"0000001006a86173c86c6d3f108eefc36e7fb014")
    bytes memory firstFunctionCallLogs = hex"0000000493e78a70";
    bytes memory secondFunctionCallLogs = hex"";
    bytes memory thirdFunctionCallLogs = hex"0000001006a86173c86c6d3f108eefc36e7fb014";
    bytes memory encodedLogs = abi.encodePacked(
      hex"0000002800000008",
      firstFunctionCallLogs,
      hex"00000000",
      secondFunctionCallLogs,
      hex"00000014",
      thirdFunctionCallLogs
    );
    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    bytes32 referenceLogsHashFromIteration1 =
      sha256(abi.encodePacked(bytes32(0), sha256(firstFunctionCallLogs)));

    bytes32 privateCircuitPublicInputsLogsHashSecondCall = sha256(secondFunctionCallLogs);

    bytes32 referenceLogsHashFromIteration2 = sha256(
      abi.encodePacked(
        referenceLogsHashFromIteration1, privateCircuitPublicInputsLogsHashSecondCall
      )
    );

    bytes32 privateCircuitPublicInputsLogsHashThirdCall = sha256(thirdFunctionCallLogs);

    bytes32 referenceLogsHashFromIteration3 = sha256(
      abi.encodePacked(referenceLogsHashFromIteration2, privateCircuitPublicInputsLogsHashThirdCall)
    );

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHashFromIteration3, "Incorrect logs hash");
  }

  function _populateInbox() internal returns (bytes32[] memory) {
    address sender = 0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc;
    bytes32 recipient = 0x1647b194c649f5dd01d7c832f89b0f496043c9150797923ea89e93d5ac619a93;
    bytes32[] memory messages = new bytes32[](16);
    for (uint256 i = 0; i < 16; i++) {
      bytes32 content = bytes32(uint256(0x401 + i));
      uint32 deadline = type(uint32).max;

      vm.prank(sender);
      bytes32 temp = inbox.sendL2Message(
        DataStructures.L2Actor({actor: recipient, version: 1}), deadline, content, bytes32(0)
      );
      messages[i] = temp;
    }
    return messages;
  }
}
