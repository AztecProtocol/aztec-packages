// SPDX-License-Identifier: Apache-2.0
// Copyright 2023 Aztec Labs.
pragma solidity >=0.8.18;

import {Test} from "forge-std/Test.sol";

import {Hash} from "@aztec/core/libraries/Hash.sol";
import {Constants} from "@aztec/core/libraries/Constants.sol";
import {DataStructures} from "@aztec/core/libraries/DataStructures.sol";
import {DecoderHelper} from "./DecoderHelper.sol";
import {Registry} from "@aztec/core/messagebridge/Registry.sol";
import {Inbox} from "@aztec/core/messagebridge/Inbox.sol";
import {Outbox} from "@aztec/core/messagebridge/Outbox.sol";
import {Rollup} from "@aztec/core/Rollup.sol";

/**
 * Blocks are generated using the `integration_l1_publisher.test.ts` tests.
 * Main use of these test is shorter cycles when updating the decoder contract.
 */
contract DecoderTest is Test {
  DecoderHelper internal helper;
  Registry internal registry;
  Inbox internal inbox;
  Outbox internal outbox;
  Rollup internal rollup;

  bytes internal block_empty_1 =
    hex"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000002d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000080668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb6710000000119c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000012b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000010668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000102d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000180668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e1500000004238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed00000002238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed000000022b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e1500000010238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed0000000200000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000";

  bytes internal block_mixed_1 =
    hex"00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000000668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000002d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000080668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb6710000000119c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000012b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000010813349a787d3f13ec3492de8b6a5c06ba871cb7d2533b8859f3c40693384501000000102e18315fa9fc796d3a94dfe61517725dec4e9d0811ce7e8ee3518cdbcf03549d000000181578dee3629aa301b877887a478484ab676934bd9f8228be7c5cdb5873f975580000000412e58befb4676abe3a279ec129e4d48b53eb1b1724a6c01274b39f6122dfc0bf00000002091367641fbcfd08d2b16d6ec75bb365bd807a436fce9163516a1de3532e8de3000000022d9b8d2353587ca56bdf967b4bb8847af3671bd6901e9e28f82c240c6e33129a1b3ab03f9b9fb0f8a31ed10a930e476c7b8bfcc9018d6dfbe20eb15838a701e9000000103036ed03e75f4893197d647af9e8f5dae3659ac9003c6b144dbb86b71820307400000002000000100000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000012100000000000000000000000000000000000000000000000000000000000001220000000000000000000000000000000000000000000000000000000000000123000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001410000000000000000000000000000000000000000000000000000000000000142000000000000000000000000000000000000000000000000000000000000014300000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000161000000000000000000000000000000000000000000000000000000000000016200000000000000000000000000000000000000000000000000000000000001630000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000018100000000000000000000000000000000000000000000000000000000000001820000000000000000000000000000000000000000000000000000000000000183000000100000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000022100000000000000000000000000000000000000000000000000000000000002220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002410000000000000000000000000000000000000000000000000000000000000242000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000261000000000000000000000000000000000000000000000000000000000000026200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000028100000000000000000000000000000000000000000000000000000000000002820000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000520000000000000000000000000000000000000000000000000000000000000052a0000000000000000000000000000000000000000000000000000000000000521000000000000000000000000000000000000000000000000000000000000052b0000000000000000000000000000000000000000000000000000000000000522000000000000000000000000000000000000000000000000000000000000052c0000000000000000000000000000000000000000000000000000000000000523000000000000000000000000000000000000000000000000000000000000052d0000000000000000000000000000000000000000000000000000000000000540000000000000000000000000000000000000000000000000000000000000054a0000000000000000000000000000000000000000000000000000000000000541000000000000000000000000000000000000000000000000000000000000054b0000000000000000000000000000000000000000000000000000000000000542000000000000000000000000000000000000000000000000000000000000054c0000000000000000000000000000000000000000000000000000000000000543000000000000000000000000000000000000000000000000000000000000054d0000000000000000000000000000000000000000000000000000000000000560000000000000000000000000000000000000000000000000000000000000056a0000000000000000000000000000000000000000000000000000000000000561000000000000000000000000000000000000000000000000000000000000056b0000000000000000000000000000000000000000000000000000000000000562000000000000000000000000000000000000000000000000000000000000056c0000000000000000000000000000000000000000000000000000000000000563000000000000000000000000000000000000000000000000000000000000056d0000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000058a0000000000000000000000000000000000000000000000000000000000000581000000000000000000000000000000000000000000000000000000000000058b0000000000000000000000000000000000000000000000000000000000000582000000000000000000000000000000000000000000000000000000000000058c0000000000000000000000000000000000000000000000000000000000000583000000000000000000000000000000000000000000000000000000000000058d00000008000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000003210000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000034100000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000361000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000003810000000426fcb9639d15aabe6d792e23ab12fb9633046d4be6911a60d64471d7560d3f6809143b7d4943a3485115d37e7596938a16c91b6055f3837640d8c36b8303bb3c06fb5fb553496e5e0b48834087e036acf99d6d935dc2ebf43c82788cb5ed1c6a2f4bd77ac2bb5474d48c2856135d18168cd6f69f77143c60b3cc370319419dac0000000000000000000000000000000000000000000000000000000000001020212121212121212121212121212121212121212100000000000000000000000000000000000000000000000000000000000010404141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000106061616161616161616161616161616161616161610000000000000000000000000000000000000000000000000000000000001080818181818181818181818181818181818181818100000010151de48ca3efbae39f180fe00b8f472ec9f25be10b4f283a87c6d7839353703914c2ea9dedf77698d4afe23bc663263eed0bf9aa3a8b17d9b74812f185610f9e1570cc6641699e3ae87fa258d80a6d853f7b8ccb211dc244d017e2ca6530f8a12806c860af67e9cd50000378411b8c4c4db172ceb2daa862b259b689ccbdc1e005f140c7c95624c8006774279a01ec1ea88617999e4fe6997b6576c4e1c7395a22048b96b586596bd740d0402e15f5577f7ceb5496b65aafc6d89d7c3b34924b0c3f2d50d16279970d682cada30bfa6b29bc0bac0ee2389f6a0444853eccaa932b2a60561da46a58569d71044a84c639e7f88429826e5622581536eb906d9cdd25a2c0a76f7da6924e10751c755227d2535f4ad258b984e78f9f452a853c52300e212d8e2069e4254d81af07744bcbb81121a38f0e2dbed69a523d3fbf85b75c287ca6f33aadbac2e4f058e05924c140d7895a6ed167caf804b710d2ae3ba62b1b51297b3ea37637af6bd56cf33425d95cc5c96e9c2ee3077322fbec86a0c7f32c15d2a888c6cc122e99478c92470a1311635142d82ad7ae67410beeef4ae31f0902ba2fb964922a4610bb18901f7b923885c1d034da5769a48203ae6f0206a92855e2c01ddb3d6553386b5580d681b8230fa4062948668f834f23e0636eaff70aaa64519aafdf4b040bd2f9836e76b9dc13cfec8065dcdf2834d786e06260d100000e1000000380000001bc00000090e7ce6b8f4ca839111391368aba73ddaaa30dbb2ea84a7ebc31360fdd96d791bc26e21020d8983010ac9b5defcc3022cd32a990c233c3ea8264eef345c880af8087b5cf483a9dff789e99bff90f94389cb0f43d02fcd3de60f75f6bd3b6130604b8f7da39176b68a0cae4b8db9fc3c6f4a81945f10fa0445f5dcfb15dc1b866e71f71b707c9515c98c60e1db4781a47000000009011eaed2e326b919e969938f1fc03a006412ea51479db25e44a2b1510a0305d810d58e81687ff90e09cb110135998a0c2d83b16f44eeb60513684e908d3706c2bdea9b8f97b28ebc872a31c92ec93a68fc816619b7303fc342c80452949c15614161193b03b3477abc00012bf92dcb0d5f9fa968b93a42bd6c6b55abedef4eee3f582fe493e586a16d181d4966996e9c400000090c9fe3e7b4b59081fe5ca3f09b3e4c254b3c38503492f04684271f91f523f67326f9fcfe3c773e156c1b922fedb70e2bc49403aa622d602f966f8356bca1438ce53e685ec1ce950aa710477f46f0d7e36714053c2586d82af6afde224ae8342006c6b792c29f5c356d989990a2bf2ce5daa615c9ff06a5f8467f0c67967850545cef942bea5645a3b3c18bf60c1fc709b000001bc00000090a5b163b7c8ee069f65747f8461dd5b3c47997f21277212b11105809d41b8f12e10b22480e593733bc0e08e83f6bfa9252d7eede7e6cba7bfdb974b25f15665645794b85062ee2e587925c503af2d786723d0eaf149db54e287f079125b5452ad9eaaab36f306390bc4bf95b1bf19d430d0f0782327fe2dd77b57150e3ceb4ee1a2e721a77896d512bce3ae29db0a5ba800000090b05ea2f2690d3950d44eccf98e6179ddc3775d5718ad447dfd4a8aa7a90d3fa3b82afde209060681a62572d5fa3ba3e051fd20b49bdf8834e858c4f86b8ac101c3da59588a35837487d5c667041300fe91b05efa8aa7e47c0054a93a02d29e0e1af5f135cd245a8c730c84993e65898ad0fa7c32d00ba2377ad7e64536ccd2e2cd5f23b6b92c75055fca8f5731f4ccf60000009011aef30f9ba5ad2b03bd1b70f35e38ceefa8b8de7c5055a1f7b000a509be97dff8ad85f723b617ff20091307b920fc687ec6f8fddc09b651d6d561a92aefe75424c2238608263119763e1a62e198ca7e7fc6d29148993d4fbb43be4916b490732792a0d6cfcdeffe1ece74ec69a7216cbf86fcd55270ef04802b9e07ba8c976a390e74c1564b95b2efb0aecc1b5aa28200000380000001bc00000090133ad72d80f42c51213b192cf9974b63130fa835d38f034e595e6f5053689eedf5af9a7bc3b18b1bba2c83fa62929ab5fb47ebea2c5cfd84e563ba5f807067587d4cb8f80c83b2d3d05060ab567935076f9c7224b833916dbb69ad87497c8ac989461bdffe346807c3d616c3b9b16429d5f7de395152390636ef2e4d9422565db50968441148e2c47bcd8cacf9beca7e0000009056200f8e93edeee8546ce592e392674778b3fb1ff3f9cc9916880c2f1032d0b8ac5ca6e120b7cb127b1c6c836ae6dc00f390c9e676d40bae9041d587d65a7b0b7cda9a334912b24c64b8bfb758123a207f3dd1ae5952e2dd1e58d798fadcc5cd223fc379cb9845fab80ccd26768306af17d271ac8f36a92134ec456cc1a271b1d57708b87408eb343a10bb92bf27db5b000000905807cbc9f2ade60b3cf6da68233174439b06977f77c614da92266588191ddff6881bdc52113f070e3a34f69fe491a64945e9b6dd47588b1615ac4d3a1ee9a552f25071921af7f2c9e6e38aa55fc4c7e8aa202da1569dc10dae5bfd9534414c4eb644eacd12aa3ccaba3178420a246fdfb752f59a1b3c4b626884e3023c31162917bd577617c444fb9fb91a9f1a190d62000001bc000000901d2d7b562023f544e0a0a9f3af059c7beb527e2c966f915948ca49404afe40ecc6f21c44aa5b5083df350c431267825026b0defc2ca9971a55c842ee15f79699ec05c26a39557c3ff101620f46fae54d724108af629ef37eb1cb303952bff0efb55d181390c59ddc79c2d314cb45b3c1dd1dc8e4b2f9ec7953f576353fd8ce44a952264c53933491fab5c2d3296b515b0000009031aac83f0bd8757f163fab216b7c9ed84fe9ef0b284349d07bed8632e794a1ab9312722056905aa75ec5160892be91fb524a6e4e1bfc4c4d94d8fb1e00661a16d21e9dd8612f39c8c4a9f84c1d217a0c5ff1ba605a2070c6b75524e2a3f2933362600d70ee3f3b5a6be1be9ba00e5512d0adf359a4126ae4116a6a6331b3f91c1bb974b5a9da69c006096856c731215800000090c6a4d7423eb21b95049931df43222b287f2498b9a1327dd42c69c40af0985c59df87c3db88dcfb92c1e0c9165b09b3aec6376d7ee01161da18e487dfb542b2209ad9e78960da2bfdac6c12e4c4aea1a23519ac851f1d5be3bd950acecec892745010a75aad105a842edb1e258a4752f27ac146ac58488bc70de6c33c79eaeb5a38d5fb9545701bd3f197c54ee18140b200000380000001bc00000090a3a512204854dd1f73326d288786e5684371f833d4464fa22f30efcdfb786652ebd6e77ab743084785ce42fd3ba1656c5ff2817e1fe939a2b7ecdd35611522c606e6a56d1524d723ee8f8818d76caf22fc9905cea0a0820e0af91368dd8fd27dc9442cbb77c0928087853add594d10c1884648c5e008b339ff79cb1319230aba82feb4f4ba8931d690fad18d8ec9f22a0000009005a516cb34b419b7d3971fe00e283fe9c78258162408e15dcdb8ab7beb98a2617f351efe2853e336617c62f59c315116017a8430f23e21c05866d6c4364f2dc3f923d47a1f071e8c096fc9d4d6119c2080b8945671e24d3397f81643a39dfedc17f574a91f805f290a5e24bbc01c9c1cc20210ef604a20c79a6db02db24644248d3426e8d2f1e1c6fbe99569f0e0996f000000907def7bd39d004343aa6fd46be27e595c76728a852b959de490a77fc2ab2e2f411f7c4b4a1f91298232fba7e06c5f5dcf407f17dab51241388d2a0f95778c8ee8955432d7765969ba99fd34a9d4e10ec51a7d65c0ed12422417a63d4a6904145267fa6ce1c2150e6a5b004107871a6966971f4d073383efec806499d0432d0199d8f02c6d2279f22609d821397ee29c5f000001bc00000090a84daff24a34c0a9c2b0dc3f69fa076bc50b3927955b6620de0a2045ca8775458df9e5915c455acf3d7a002e8074584961666a5bc53700afea30807e0142b7622c59938c18726316d79309734f0a022d47739a52e0bcc758143ccc6b960a54424404d0304a16f3848630f54cacf96986238938f24c14d3dfe11f8499be01a6afa20beab14016365b95a8e31d1235984600000090b4933b0e1bdc4949c769a757ad771aeb632916ced2eb0d90a276b9cdb0d6eb409aa8d3ebdfb5acb626c6adb9df9bb8bd5c85e9c19c6deceff3bc362c127fb0489fa55e8fe02ffbd857b9487368204fea683f7fc81c3594929ba825e9e52c0211593cf4ec9d9776ac4205363878b253c52fc4fbce85a6cd85fee35784505693e5ac9773c7729e92e10c01f7f0aa811032000000909feddc51decb797897d68306142161b08fc2a19c798f21a9801087f2b767372f9a1ce75ed108d351b774e1ce9aeb90133292f6bdf2f91db033375473e79e4a33f4d2b69ff1fc6734b7f4e7632e6db6502879a16e222f7f2e91c5215c03d6ea988110440d2b648e70cad15d754e0159129ba7c6a3a87c489e46c34c90663e0f73b049db38b6fcb314cbd532e50985416f00000380000001bc00000090e62893a128cccced5f824264be4260034766e93bd4994c320b824c5b647f09806ead2868ef4416308e305a1be348b68ee1c936dd48603704310341dae8e3094f719398962306e501786bf9473a93212197392db3796562d9aa80e8ced37d9b959fe5e3977c31a67a24379e8ca43f5be1a67ea338150cfda89e6f7a1b3e4a7fbc2291687eb8f703f48a4b132aeeba43be00000090b6bc3e9c1fdde65783e52cd32037dc50bfdd3cc4cc366867804993d97b35e812853db58144504aa66de8733460de812a6c6960a13dd6676508e01b90d8da12a123ec2e6668fa6b55247246066dc2514394a87cd9a3caa05aff375793218d903b65fbc1c2f348a347e836d428c85f54c8cb04db963dc79f73e42fe85a40a05e3cf078440539a5630081367511191d66b400000090dfa1738dd892360c7af601fa06f35015084311eefa25a40402bc817b0fc4c0b0f4ae46e46df79970c45436ef23bc53b9345e2443dc6d8a0d48208b8e8a53ebcc47c1553285044a89d2b1d3c3c010d454ea46186ad12fd3a9cd7c72da6580fba59a8738290c87939b48d5468a9d9a2e7cab01760c65b55a621731e9d8abd6b636f442786e8c8473f11cc9afdcdb2016a4000001bc000000905ea5bd19bfc0811f6111fe80a7015f8df58aa05a1cabd9bd793da0eca447e06d5be4055b5962424cafde90d79f1a85d1af9b894c1506bf4f9afee4e0a0e08c65da68defead1535d0230cead337dd0bacdbd3e4ade41a313123e71ab38117146e53a363671bac54b6e12cdb84395dc149011e86c463d18e868b6ca0e74bfe8cb8b83620415af638f4d762c6dae75c3c4a00000090cc6f074a2082a3b1b73432cd060e28a831f77abf9e70abeb7cb82ac928572efa9a1462fce45535f81064405af80c7db9833ad806852e0ef81be862540a1c506ec0d3d186b5176001214774983c73479aefe2217f1ec08b0c982554e69ffea936e7b4e882cd7a61d68af28d5861c904c8b68eb6ff67c1305b192730d4238b8b3773aa1c3b90749fbcb5aed01993d3e2aa000000902ae1e13bce33d8fbfce0a2e65db432e5de7f93ac02fc440a6364a25aeef4a399597d80206ea13ce5131c53b13315ef0b247ace1a1d0af2744cf7fe0474550dd48d4f1306f5cb687471b1555a15b8d5c0eceef1d131c3a1dbb508060b8888812a7d6c326034b9855bdba54bb1bd8569c4be3515dc5cb447f4ef90c946be59f534caa413630ef1bae4b3d96558ad47a650";

  function setUp() public virtual {
    helper = new DecoderHelper();

    registry = new Registry();
    inbox = new Inbox(address(registry));
    outbox = new Outbox(address(registry));
    rollup = new Rollup(registry);

    registry.upgrade(address(rollup), address(inbox), address(outbox));
  }

  function testEmptyBlock() public virtual {
    (bytes32 diffRoot, bytes32 l1ToL2MessagesHash) =
      helper.computeDiffRootAndMessagesHash(block_empty_1);
    assertEq(
      diffRoot,
      0x5839961bac64bb22cf48aaa99c963c37ec2168743fc4125b7aead2793d8dbde8,
      "Invalid diff root/calldata hash"
    );

    assertEq(
      l1ToL2MessagesHash,
      0x076a27c79e5ace2a3d47f9dd2e83e4ff6ea8872b3c2218f66c92b89b55f36560,
      "Invalid messages hash"
    );

    (
      uint256 l2BlockNumber,
      bytes32 startStateHash,
      bytes32 endStateHash,
      bytes32 publicInputsHash,
      bytes32[] memory l2ToL1Msgs,
      bytes32[] memory l1ToL2Msgs
    ) = helper.decode(block_empty_1);

    assertEq(l2BlockNumber, 2, "Invalid block number");
    assertEq(
      startStateHash,
      0xca91a84435129ce01602cf819855fd9ce00b768279e4a5133d2515592e2b061b,
      "Invalid start state hash"
    );
    assertEq(
      endStateHash,
      0x1d8d13ed1e858769c8632feb2eed029fc8616c491494c6f7452360718c1a9426,
      "Invalid end state hash"
    );
    assertEq(
      publicInputsHash,
      0x2baf2ca94d1af42ed94911b73fdadfaf02270c1c00f14313f30fabbf67a7c2e4,
      "Invalid public input hash"
    );

    for (uint256 i = 0; i < l2ToL1Msgs.length; i++) {
      assertEq(l2ToL1Msgs[i], bytes32(0), "Invalid l2ToL1Msgs");
    }
    for (uint256 i = 0; i < l1ToL2Msgs.length; i++) {
      assertEq(l1ToL2Msgs[i], bytes32(0), "Invalid l1ToL2Msgs");
    }
  }

  function testMixBlock() public virtual {
    (
      uint256 l2BlockNumber,
      bytes32 startStateHash,
      bytes32 endStateHash,
      bytes32 publicInputsHash,
      bytes32[] memory l2ToL1Msgs,
      bytes32[] memory l1ToL2Msgs
    ) = helper.decode(block_mixed_1);

    (bytes32 diffRoot, bytes32 l1ToL2MessagesHash) =
      helper.computeDiffRootAndMessagesHash(block_mixed_1);

    assertEq(l2BlockNumber, 1, "Invalid block number");
    assertEq(
      diffRoot,
      0x25ca36c6061292690d326f3643857fec9ae7d9c779d07102b2e9f0fb99b2fa02,
      "Invalid diff root/calldata hash"
    );
    assertEq(
      l1ToL2MessagesHash,
      0xb213c9c543fce2a66720d26a913fe0d018f72a47ccfe698baafcf4cced343cfd,
      "Invalid messages hash"
    );
    assertEq(
      startStateHash,
      0x3f44449b8c2d3d36f6fe121c5d8d6961cd038fd4135fdf1ced70df6eb5f6ac26,
      "Invalid start state hash"
    );
    assertEq(
      endStateHash,
      0x1e54f0c574c9a0f80c56323046cd03448e26adf70184d04d44b58659e2828e56,
      "Invalid end state hash"
    );
    assertEq(
      publicInputsHash,
      0x22b7fdde71b2d593ed987c9ed8b796081d6cb5a8edbc469f4101affd298034f8,
      "Invalid public input hash"
    );

    for (uint256 i = 0; i < l2ToL1Msgs.length; i++) {
      // recreate the value generated by `integration_l1_publisher.test.ts`.
      bytes32 expectedValue = bytes32(uint256(0x300 + 32 * (1 + i / 2) + i % 2));
      assertEq(l2ToL1Msgs[i], expectedValue, "Invalid l2ToL1Msgs");
    }
    bytes32[] memory expectedL1ToL2Msgs = _populateInbox();
    for (uint256 i = 0; i < l1ToL2Msgs.length; i++) {
      assertEq(l1ToL2Msgs[i], expectedL1ToL2Msgs[i], "Invalid l1ToL2Msgs");
    }
  }

  function testComputeKernelLogsIterationWithoutLogs() public {
    bytes memory kernelLogsLength = hex"00000004"; // 4 bytes containing value 4
    bytes memory iterationLogsLength = hex"00000000"; // 4 empty bytes indicating that length of this iteration's logs is 0
    bytes memory encodedLogs = abi.encodePacked(kernelLogsLength, iterationLogsLength);

    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    bytes32 kernelPublicInputsLogsHash = bytes32(0);
    bytes32 privateCircuitPublicInputsLogsHash = sha256(new bytes(0));

    bytes32 referenceLogsHash =
      sha256(abi.encodePacked(kernelPublicInputsLogsHash, privateCircuitPublicInputsLogsHash));

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHash, "Incorrect logs hash");
  }

  function testComputeKernelLogs1Iteration() public {
    // || K_LOGS_LEN | I1_LOGS_LEN | I1_LOGS ||
    // K_LOGS_LEN = 4 + 8 = 12 (hex"0000000c")
    // I1_LOGS_LEN = 8 (hex"00000008")
    // I1_LOGS = 8 bytes (hex"0000000493e78a70") // Note: 00000004 is the length of 1 log within function logs
    bytes memory firstFunctionCallLogs = hex"0000000493e78a70";
    // Prefix logs with length of kernel logs (12) and length of iteration 1 logs (8)
    bytes memory encodedLogs = abi.encodePacked(hex"0000000c00000008", firstFunctionCallLogs);
    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    // Zero because this is the first iteration
    bytes32 previousKernelPublicInputsLogsHash = bytes32(0);
    bytes32 privateCircuitPublicInputsLogsHashFirstCall = sha256(firstFunctionCallLogs);

    bytes32 referenceLogsHash = sha256(
      abi.encodePacked(
        previousKernelPublicInputsLogsHash, privateCircuitPublicInputsLogsHashFirstCall
      )
    );

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHash, "Incorrect logs hash");
  }

  function testComputeKernelLogs2Iterations() public {
    // || K_LOGS_LEN | I1_LOGS_LEN | I1_LOGS | I2_LOGS_LEN | I2_LOGS ||
    // K_LOGS_LEN = 4 + 8 + 4 + 20 = 36 (hex"00000024")
    // I1_LOGS_LEN = 8 (hex"00000008")
    // I1_LOGS = 8 random bytes (hex"0000000493e78a70")
    // I2_LOGS_LEN = 20 (hex"00000014")
    // I2_LOGS = 20 bytes (hex"0000001006a86173c86c6d3f108eefc36e7fb014")
    bytes memory firstFunctionCallLogs = hex"0000000493e78a70";
    bytes memory secondFunctionCallLogs = hex"0000001006a86173c86c6d3f108eefc36e7fb014";
    bytes memory encodedLogs = abi.encodePacked(
      hex"0000002400000008", firstFunctionCallLogs, hex"00000014", secondFunctionCallLogs
    );
    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    bytes32 referenceLogsHashFromIteration1 =
      sha256(abi.encodePacked(bytes32(0), sha256(firstFunctionCallLogs)));

    bytes32 privateCircuitPublicInputsLogsHashSecondCall = sha256(secondFunctionCallLogs);

    bytes32 referenceLogsHashFromIteration2 = sha256(
      abi.encodePacked(
        referenceLogsHashFromIteration1, privateCircuitPublicInputsLogsHashSecondCall
      )
    );

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHashFromIteration2, "Incorrect logs hash");
  }

  function testComputeKernelLogsMiddleIterationWithoutLogs() public {
    // || K_LOGS_LEN | I1_LOGS_LEN | I1_LOGS | I2_LOGS_LEN | I2_LOGS | I3_LOGS_LEN | I3_LOGS ||
    // K_LOGS_LEN = 4 + 8 + 4 + 0 + 4 + 20 = 40 (hex"00000028")
    // I1_LOGS_LEN = 8 (hex"00000008")
    // I1_LOGS = 8 random bytes (hex"0000000493e78a70")
    // I2_LOGS_LEN = 0 (hex"00000000")
    // I2_LOGS = 0 bytes (hex"")
    // I3_LOGS_LEN = 20 (hex"00000014")
    // I3_LOGS = 20 random bytes (hex"0000001006a86173c86c6d3f108eefc36e7fb014")
    bytes memory firstFunctionCallLogs = hex"0000000493e78a70";
    bytes memory secondFunctionCallLogs = hex"";
    bytes memory thirdFunctionCallLogs = hex"0000001006a86173c86c6d3f108eefc36e7fb014";
    bytes memory encodedLogs = abi.encodePacked(
      hex"0000002800000008",
      firstFunctionCallLogs,
      hex"00000000",
      secondFunctionCallLogs,
      hex"00000014",
      thirdFunctionCallLogs
    );
    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    bytes32 referenceLogsHashFromIteration1 =
      sha256(abi.encodePacked(bytes32(0), sha256(firstFunctionCallLogs)));

    bytes32 privateCircuitPublicInputsLogsHashSecondCall = sha256(secondFunctionCallLogs);

    bytes32 referenceLogsHashFromIteration2 = sha256(
      abi.encodePacked(
        referenceLogsHashFromIteration1, privateCircuitPublicInputsLogsHashSecondCall
      )
    );

    bytes32 privateCircuitPublicInputsLogsHashThirdCall = sha256(thirdFunctionCallLogs);

    bytes32 referenceLogsHashFromIteration3 = sha256(
      abi.encodePacked(referenceLogsHashFromIteration2, privateCircuitPublicInputsLogsHashThirdCall)
    );

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHashFromIteration3, "Incorrect logs hash");
  }

  function _populateInbox() internal returns (bytes32[] memory) {
    address sender = 0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc;
    bytes32 recipient = 0x1647b194c649f5dd01d7c832f89b0f496043c9150797923ea89e93d5ac619a93;
    bytes32[] memory messages = new bytes32[](16);
    for (uint256 i = 0; i < 16; i++) {
      bytes32 content = bytes32(uint256(0x401 + i));
      uint32 deadline = type(uint32).max;

      vm.prank(sender);
      bytes32 temp = inbox.sendL2Message(
        DataStructures.L2Actor({actor: recipient, version: 1}), deadline, content, bytes32(0)
      );
      messages[i] = temp;
    }
    return messages;
  }
}
