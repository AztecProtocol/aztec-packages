// SPDX-License-Identifier: Apache-2.0
// Copyright 2023 Aztec Labs.
pragma solidity >=0.8.18;

import {Test} from "forge-std/Test.sol";

import {Hash} from "@aztec/core/libraries/Hash.sol";
import {Constants} from "@aztec/core/libraries/Constants.sol";
import {DataStructures} from "@aztec/core/libraries/DataStructures.sol";
import {DecoderHelper} from "./DecoderHelper.sol";
import {Registry} from "@aztec/core/messagebridge/Registry.sol";
import {Inbox} from "@aztec/core/messagebridge/Inbox.sol";
import {Outbox} from "@aztec/core/messagebridge/Outbox.sol";
import {Rollup} from "@aztec/core/Rollup.sol";

/**
 * Blocks are generated using the `integration_l1_publisher.test.ts` tests.
 * Main use of these test is shorter cycles when updating the decoder contract.
 */
contract DecoderTest is Test {
  DecoderHelper internal helper;
  Registry internal registry;
  Inbox internal inbox;
  Outbox internal outbox;
  Rollup internal rollup;

  bytes internal block_empty_1 =
    hex"000000020668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000102d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000180668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e1500000004238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed00000002238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed000000022b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e1500000010238b20b7bc1d5190f8e928eb2aa2094412588f9cad6c7862f69c09a9b246d6ed000000020668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000202d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000280668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e1500000008236394e84a01824e286653b542a923474253251e86c118f02978d5714538236c00000003236394e84a01824e286653b542a923474253251e86c118f02978d5714538236c000000032b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e1500000020236394e84a01824e286653b542a923474253251e86c118f02978d5714538236c0000000300000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000";

  bytes internal block_mixed_1 =
    hex"000000010668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e15000000002d39729fd006096882acfbd350c91fd61883578b4fe35b63cdce3c1993a497ea000000080668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb6710000000119c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000012b72136df9bc7dc9cbfe6b84ec743e8e1d73dd93aecfa79f18afb86be977d3eb0668938c4a4167faa2b5031e427d74d6e38638d2eef68834b70480c5a93f8e150000000019c36f7bc2e4116d082865cc0b4ac8e16e9efa00ace9fb2222dd1dfd719cb671000000010813349a787d3f13ec3492de8b6a5c06ba871cb7d2533b8859f3c40693384501000000102e18315fa9fc796d3a94dfe61517725dec4e9d0811ce7e8ee3518cdbcf03549d000000181578dee3629aa301b877887a478484ab676934bd9f8228be7c5cdb5873f975580000000412e58befb4676abe3a279ec129e4d48b53eb1b1724a6c01274b39f6122dfc0bf00000002091367641fbcfd08d2b16d6ec75bb365bd807a436fce9163516a1de3532e8de3000000022d9b8d2353587ca56bdf967b4bb8847af3671bd6901e9e28f82c240c6e33129a1b3ab03f9b9fb0f8a31ed10a930e476c7b8bfcc9018d6dfbe20eb15838a701e9000000103036ed03e75f4893197d647af9e8f5dae3659ac9003c6b144dbb86b71820307400000002000000100000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000012100000000000000000000000000000000000000000000000000000000000001220000000000000000000000000000000000000000000000000000000000000123000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001410000000000000000000000000000000000000000000000000000000000000142000000000000000000000000000000000000000000000000000000000000014300000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000161000000000000000000000000000000000000000000000000000000000000016200000000000000000000000000000000000000000000000000000000000001630000000000000000000000000000000000000000000000000000000000000180000000000000000000000000000000000000000000000000000000000000018100000000000000000000000000000000000000000000000000000000000001820000000000000000000000000000000000000000000000000000000000000183000000100000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000022100000000000000000000000000000000000000000000000000000000000002220000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000002410000000000000000000000000000000000000000000000000000000000000242000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000261000000000000000000000000000000000000000000000000000000000000026200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000280000000000000000000000000000000000000000000000000000000000000028100000000000000000000000000000000000000000000000000000000000002820000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000520000000000000000000000000000000000000000000000000000000000000052a0000000000000000000000000000000000000000000000000000000000000521000000000000000000000000000000000000000000000000000000000000052b0000000000000000000000000000000000000000000000000000000000000522000000000000000000000000000000000000000000000000000000000000052c0000000000000000000000000000000000000000000000000000000000000523000000000000000000000000000000000000000000000000000000000000052d0000000000000000000000000000000000000000000000000000000000000540000000000000000000000000000000000000000000000000000000000000054a0000000000000000000000000000000000000000000000000000000000000541000000000000000000000000000000000000000000000000000000000000054b0000000000000000000000000000000000000000000000000000000000000542000000000000000000000000000000000000000000000000000000000000054c0000000000000000000000000000000000000000000000000000000000000543000000000000000000000000000000000000000000000000000000000000054d0000000000000000000000000000000000000000000000000000000000000560000000000000000000000000000000000000000000000000000000000000056a0000000000000000000000000000000000000000000000000000000000000561000000000000000000000000000000000000000000000000000000000000056b0000000000000000000000000000000000000000000000000000000000000562000000000000000000000000000000000000000000000000000000000000056c0000000000000000000000000000000000000000000000000000000000000563000000000000000000000000000000000000000000000000000000000000056d0000000000000000000000000000000000000000000000000000000000000580000000000000000000000000000000000000000000000000000000000000058a0000000000000000000000000000000000000000000000000000000000000581000000000000000000000000000000000000000000000000000000000000058b0000000000000000000000000000000000000000000000000000000000000582000000000000000000000000000000000000000000000000000000000000058c0000000000000000000000000000000000000000000000000000000000000583000000000000000000000000000000000000000000000000000000000000058d00000008000000000000000000000000000000000000000000000000000000000000032000000000000000000000000000000000000000000000000000000000000003210000000000000000000000000000000000000000000000000000000000000340000000000000000000000000000000000000000000000000000000000000034100000000000000000000000000000000000000000000000000000000000003600000000000000000000000000000000000000000000000000000000000000361000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000003810000000426fcb9639d15aabe6d792e23ab12fb9633046d4be6911a60d64471d7560d3f6809143b7d4943a3485115d37e7596938a16c91b6055f3837640d8c36b8303bb3c06fb5fb553496e5e0b48834087e036acf99d6d935dc2ebf43c82788cb5ed1c6a2f4bd77ac2bb5474d48c2856135d18168cd6f69f77143c60b3cc370319419dac0000000000000000000000000000000000000000000000000000000000001020212121212121212121212121212121212121212100000000000000000000000000000000000000000000000000000000000010404141414141414141414141414141414141414141000000000000000000000000000000000000000000000000000000000000106061616161616161616161616161616161616161610000000000000000000000000000000000000000000000000000000000001080818181818181818181818181818181818181818100000010151de48ca3efbae39f180fe00b8f472ec9f25be10b4f283a87c6d7839353703914c2ea9dedf77698d4afe23bc663263eed0bf9aa3a8b17d9b74812f185610f9e1570cc6641699e3ae87fa258d80a6d853f7b8ccb211dc244d017e2ca6530f8a12806c860af67e9cd50000378411b8c4c4db172ceb2daa862b259b689ccbdc1e005f140c7c95624c8006774279a01ec1ea88617999e4fe6997b6576c4e1c7395a22048b96b586596bd740d0402e15f5577f7ceb5496b65aafc6d89d7c3b34924b0c3f2d50d16279970d682cada30bfa6b29bc0bac0ee2389f6a0444853eccaa932b2a60561da46a58569d71044a84c639e7f88429826e5622581536eb906d9cdd25a2c0a76f7da6924e10751c755227d2535f4ad258b984e78f9f452a853c52300e212d8e2069e4254d81af07744bcbb81121a38f0e2dbed69a523d3fbf85b75c287ca6f33aadbac2e4f058e05924c140d7895a6ed167caf804b710d2ae3ba62b1b51297b3ea37637af6bd56cf33425d95cc5c96e9c2ee3077322fbec86a0c7f32c15d2a888c6cc122e99478c92470a1311635142d82ad7ae67410beeef4ae31f0902ba2fb964922a4610bb18901f7b923885c1d034da5769a48203ae6f0206a92855e2c01ddb3d6553386b5580d681b8230fa4062948668f834f23e0636eaff70aaa64519aafdf4b040bd2f9836e76b9dc13cfec8065dcdf2834d786e06260d100000e1000000380000001bc0000009072e00ac199039c63d022e3654a8261e694431c62056eb7d8e5db4c455ad9c381ec7e8c4804d7be58d2d24f1bb446ef9c097f112f54f1c890b401927d8c14db9ce209f200b3a78e24acf76f1fdfb833bc87d9bcf4f1bf74cdd694fc2ad5e4456a727d4de19f78c5db5ec9b01173a8809029a4d08727f001e71c67bacf5e262d1207f051a101ff1198da289da236cbb5170000009078b47dc02a9536d78b99a91c034cf9c4d24d9ab79ce71275502b98df23f2d048380c007f843b93774f562c63bb021126de1d4ae327889b7d8adca04748176ad7847bcf5780a76cb5ce09a779f1095a4a6e40b7b1da5f40fdd68e37a1f169a0f29a578230f6eab93d809a53d3620bcdcce099b88b6ef025d98f0a1f50cb82e548935486b3fbc16f6941b094e24548265100000090831d0f6df59dc54f6cd81e3522cd77ccb772eabd445767fb56eea880b14de14e4157da9931eecf53a22d22cfd715132ee4ea009ec2a650df1fbb0b08d2174053a449b1e1377f06b1ef506495637ad282b8ca070e354d3aedd1a6010f074707a33a0b5102e82d9d17f9a121004c187dbf560f2f5a8a6575a9cdff997cdd151ba3fd9779aab9d19b7f05a09e5beca9ffa9000001bc000000900b994e74dcd6bcef2b488bdd9d800719283ad9c4fca4cfa58ba24040c772b96069fb4714cf4f8d0f0fc418bf93e9467ca3d3fd39ae69e77d20b50c8c36d367e0feebda5cea829a57a365b6e691e36364fd000c749b1134950e62b2ca3981ef420fe5002977e879dd7cca98e60901eacffdab22e2273958a5e35ef5c23c6003099ba91fbc8cdf1c96702eb4574717b16c0000009081b2241046f3e30b9fc1a707f8dc63e004bd804799cb5570aaee9a97513247d334e4b996126e04cebe47446ed2270802f0e3a700dd357ae9c2ce465e27aa9d94e07e6819f55b0c615e375167de74dc655226a43b1797ab898c04de1e04f6966af6a76b0c610660f55739d9c99b408a1ec54ecaa5035c600021921d19a9aef4502e2695d27eb860da0e507fa7f82d762e00000090f6dc77421d88719308275812cb54030ecafb5424fd0737c535954a03e5351addd5963c5171e4dceeb9938227a71fd69df824526d0756aaae3ba7bb424f445e0baa964ab34b4e273a8f78d8dca828dc4c721521f5fc539059e390f30a3b55f6bef403377188b84e0bd800f8df84b3b7f8eb4e937ca56557dc8b5c7f936486dde2958ccdac3c0df5de851fd250c934a25b00000380000001bc0000009027d8d13f10e00fd185584e3ceeaade6a03d9a6dc92223613f5651c30028148689f417cbd96a6fb36770bdc6996c013558c785f488d9529637d932bda4b28b880a720de1e5fe5fa1ce9c252c2851ad030b76c2f197d30691c8b9c0347303a5cef92261cb96cfaa46d2dd39b3ce154e94b33e387ca638848e99e4c16134942578d43fa72644e7044a16cbd665524d22108000000907a04ee24b2e3b843c1bcc1d964654a0da341cdbfd401411939438642d12ae3b05ff0666bcecd7eda6c4d188572d0846803ca89bdebd82a2f726595cefd9eb6a13e1693352187f7e108a5604b83e1f5ec7ca9046ef2d48ef7700d86b39bdde52b56609160083ef2849566f8211e9db927619117e8c2b08e9b60537be748ea77e9b53831e38c6c235069a853c05b00b0770000009011b60f750164609f0ab2b106e37fade240f36b547e7db8a7ba20db4fc3f959da895d9d9d06ed20fb437ba325d7c459d9c4746fdd65437d2464408b2cebe8db2a764e9f194e2eec6523e70b1891029d92766deb46773e32d3261889614e9c7af67ecd5c5b042dba8d7378b49fec5e2fec36695cf853413f484b494b22053ee3d8a7e20744f19a83e14b2f4463f7db6bda000001bc000000905390e4c97bd17e71e27cff1bf67bb3232e8720dc91a4366c7c6bbefb41eb580b68c8f0279b746f7bd015795bbdb9e5685e67c272069d7ab4ce4fc6bf7367be9a04f4b287a1a4548a4337975778118ca938b411f2b40245e0ad6d097c3c4a817be98325ee908b48f285b6db00663eeee61b257da68c621a2d35d9430fc088fb8048380547981fc91e2a57e526d81019f0000000905993df0a1980841840280ffe2dcff5e4dbf4df72cbac26ea97c21dca0456aa60c905ea9062435f02cca30732dfee413da62aef24ae8eca05b3ef75bb75a1e21fc5cf0d8d1d64f1f98416f67d8d2762410f2bfc8ccf1edf19e94455057732a0e7893d78be21a8326ecbd3f1df416a5c69aa60e759480f4a685c92cd3bc9ca19ba1490340b6ff46a102c4b2f8f312a08b10000009089a029c6028e9579963949a993a0e2da8f115c0bba1922528d6d5afa837190fb2e02cc4bac271afe475366da2e1204bf67a2ed47a57e6bfc3bad28d20bab5f0c19f9312092d5a0e113cb2fb9a758709d2f199cec0d859d017260914d5a352974a15c5ad622127c37f1a68f88199096a2c3b486912ce2ded1a471ae24a4d63dce6b556716e9626379ebd4edc1969a0b9c00000380000001bc000000901a911eee13e7d12fd506f8c8e4a5241879d3bf829531fc2a99edd8e37801f275f532b2853dfb6466d7d905c98669d79af37451d82f023353d3d14805e43bb02ef1cba77620fa74f6e6d4d889d1c810d9b7b4975ca19cb5b555c241cbcfbf581d43d5a81c08c085d2721bf8a6a055cce5effbf826499e247716d81a424027556fcbadf7610ab612283e57a79da9921644000000901149db151803e90a66214707edbda6813f7d53b43844b0843ba5089553a74a33bf41b2ebec09a86572ce4f465af03d2204d824e3a5bcc0f110270c15379e24034c736ee4bd57f1aead4c59efee6ba375c7f3ffb70eb99cc2becdccc9333039ccf0c43df80e5357e47d75064dea4d535e3f6bc55e38102596aa45e12c2390a116bafd402d35f69d2ff35b9d30fcbb79060000009046686bc5cf84791ab8cba777d156fb0a1523403cb547d9ed138f48d7da1bdf4d422a198f2642361b6f8522cda884ff98c653c41da4b1c30126f648ea177248a48110a89eba5a68a2d22634580aa07166113de68ffe40b04211957a61509021cccd8ecc70a7b173ffc8bdeecc3bd91144bb08879bb6b41e6a55336b01ba056860bf4aead4c29cfeb356c12700fe9dc44f000001bc0000009069450cbad55cba7699cf4169bd0d84b4084a490e226629335f6d1a5f7ba3918ebfc603291075420e97aa39b94505cd954af8ce87011a69416b0583196347aa25232ffe73d53393a2987d21b8995602257f547df7d78ef625d1255770fdb21160206ad268e66d1b29d5dd3c3443491baee6969a2759dc57bee02c445ec32c70b8ee17dcbfcbcb07675bffbe7506be970d00000090c0946fab83288189d8941b3bfe689c9066937ae7cf7acf8f06f17e91059a3d3c3ab461e0aa7694d01f79d279b385388fe74487b7cd5806aa40183f0410f832a25738e69972e655d27fefc5da57916df34427dd95ba12107b9f672a7db287ec7fa062152f07f1f2bd3450ed8b1382397d3d07e1a71c8af3402083fe2e0661142a68f73d01eb03d8713705cc559f0802e60000009009e1e00587869c6bb6a6da4b5175a4c01ef134e10ffbea2764dddb4e4cbcae14c206badb7f06623291598b2a2f707b0a65d5960bb1e0c667516866353456a55042ca83279a83c9c4e2aae0f398265aed53321926c7b29e1b8ced9cf8ac4f982b7b5bc17c445e9a34aad8942d0f93570675cd44e5baa061701d3714e41ea4321b1d15c3a508215c2626b8be11787a6dc200000380000001bc0000009060bd3da3c0c9a3ea6f9bd2b80f358e5b5f947213aec718de6e34eff9b759040ea853c67a0ece253b7bb5210d3e884f0f4e52e40d516eedfd2177501453d9e919b57f11d121215deaf1a0c3e85769d0f33ff9446ab0e4a0628958c7c5710b63f0b043099a4fd015a5f69b8cbeb759a617cbbbe82009eb814da07ba8070827fecc387ceef1f01be49f0d997424885dc0b000000090db27b13aac0c4b52ed49a9f3a6fa68cea54347612fa9c1c3d1db61563457074a2e81b5bd59626efc214d658cc105f740e98a67ed738b8120a57b7b95f560575f553c6614484acde24b3f67e5373a3ec659d0de5bc0a2efa13a5ca1a25d4774f17c837c0d7018268cffeb2b130b69bfe7d0e43f2fe57926a8011bdfd09e03b0f27975ab9b97371c9ca3f13ba34eed08dd00000090da585e2184452f14ff88c4bc004a0026f664509509b720ea44b2df59c52e4d1935e36ae76525e962df10c3097f8f6577fab02b2739268312daf5d79c756109485b19aca1184a5a28c416f2756761f583e03b2ad49b3e8dc099da73248e44d04bee66605f3f4320a02db76a55883bfb29790365ea9991a29cd4a6c3bd09fc70b401943f5e512f8bb878d5b0432e686da3000001bc00000090f70e5e3f1d8c6ff6fe772c7777adf7dbfa1803127ecb65279731580f4c149c8b8dc555fbfa4fd8f431adc0af42308e173cae4ee7cdc795e2ed5005146cbc3f5b61ab96a69626a48ab9b450d59b3a3aa6065afc0b290d87884bc3c3acf5ceb1b3e70ba16a68c605d865efb0a1f555cccb0f8fbcf788313baf6e218becec5803ca418f0d725c8d23e93828ef7fd9fafd3000000090aa3ad55008944c461b15642fccca9590ea5b9bbbdb07673a3e4195e4b0a04d944ea5e724a82888ab7cd89e1949eb28d9a054f9567744e70575335eccd2900eeb72ca336ef8323a8439aec04ffb7ff55ace60edd883e934dbf38db9c25bd5c2fe781643a07d4c9136eb8420f9a1a1d2f90182531b912923db5c101303397a425e0f2773a38b989b89a76e90b922eb0a3100000090ab36f55c1a63a848706755f6d6e768fc68e3f785d50b4970820725fcdfbabe4cbe88ae5ea20ae1705ed0f562a53f4f92c85d013854045551b0a44081a810d8db3d056e0bac6fd7e5ff0f23b1db068bb58190a8bede5295e617e50561d9982645792d23eb33d7ef6ae9c7a9ee51f7d806a0f17775452f05ddda359bbb8915917c36511b4bf1c6cc0a37cf330b5228cc58";

  function setUp() public virtual {
    helper = new DecoderHelper();

    registry = new Registry();
    inbox = new Inbox(address(registry));
    outbox = new Outbox(address(registry));
    rollup = new Rollup(registry);

    registry.upgrade(address(rollup), address(inbox), address(outbox));
  }

  function testEmptyBlock() public virtual {
    (bytes32 diffRoot, bytes32 l1ToL2MessagesHash) =
      helper.computeDiffRootAndMessagesHash(block_empty_1);
    assertEq(
      diffRoot,
      0x5839961bac64bb22cf48aaa99c963c37ec2168743fc4125b7aead2793d8dbde8,
      "Invalid diff root/calldata hash"
    );

    assertEq(
      l1ToL2MessagesHash,
      0x076a27c79e5ace2a3d47f9dd2e83e4ff6ea8872b3c2218f66c92b89b55f36560,
      "Invalid messages hash"
    );

    (
      uint256 l2BlockNumber,
      bytes32 startStateHash,
      bytes32 endStateHash,
      bytes32 publicInputsHash,
      bytes32[] memory l2ToL1Msgs,
      bytes32[] memory l1ToL2Msgs
    ) = helper.decode(block_empty_1);

    assertEq(l2BlockNumber, 2, "Invalid block number");
    assertEq(
      startStateHash,
      0xca91a84435129ce01602cf819855fd9ce00b768279e4a5133d2515592e2b061b,
      "Invalid start state hash"
    );
    assertEq(
      endStateHash,
      0x1d8d13ed1e858769c8632feb2eed029fc8616c491494c6f7452360718c1a9426,
      "Invalid end state hash"
    );
    assertEq(
      publicInputsHash,
      0x2baf2ca94d1af42ed94911b73fdadfaf02270c1c00f14313f30fabbf67a7c2e4,
      "Invalid public input hash"
    );

    for (uint256 i = 0; i < l2ToL1Msgs.length; i++) {
      assertEq(l2ToL1Msgs[i], bytes32(0), "Invalid l2ToL1Msgs");
    }
    for (uint256 i = 0; i < l1ToL2Msgs.length; i++) {
      assertEq(l1ToL2Msgs[i], bytes32(0), "Invalid l1ToL2Msgs");
    }
  }

  function testMixBlock() public virtual {
    (bytes32 diffRoot, bytes32 l1ToL2MessagesHash) =
      helper.computeDiffRootAndMessagesHash(block_mixed_1);
    assertEq(
      diffRoot,
      0x705f9c21bf4a9e898ddf1a175ce98ba796eb9008e6464d3e6dac6015550e099c,
      "Invalid diff root/calldata hash"
    );

    assertEq(
      l1ToL2MessagesHash,
      0xb213c9c543fce2a66720d26a913fe0d018f72a47ccfe698baafcf4cced343cfd,
      "Invalid messages hash"
    );

    (
      uint256 l2BlockNumber,
      bytes32 startStateHash,
      bytes32 endStateHash,
      bytes32 publicInputsHash,
      bytes32[] memory l2ToL1Msgs,
      bytes32[] memory l1ToL2Msgs
    ) = helper.decode(block_mixed_1);

    assertEq(l2BlockNumber, 1, "Invalid block number");
    assertEq(
      startStateHash,
      0x5b2a06b296be0ef96e45df6e8f927bfc1ca9a5061a5a173f6aa5084421cee34e,
      "Invalid start state hash"
    );
    assertEq(
      endStateHash,
      0x839ccff0773e7ba72cdb5f98b961cca40fcc39889d207e641a79e2ab9128862a,
      "Invalid end state hash"
    );
    assertEq(
      publicInputsHash,
      0x1d7b0de8788ec94e9dcbd296322d91caf7f59f9dc549fe152cc02e9289f7f104,
      "Invalid public input hash"
    );

    for (uint256 i = 0; i < l2ToL1Msgs.length; i++) {
      // recreate the value generated by `integration_l1_publisher.test.ts`.
      bytes32 expectedValue = bytes32(uint256(0x300 + 32 * (1 + i / 2) + i % 2));
      assertEq(l2ToL1Msgs[i], expectedValue, "Invalid l2ToL1Msgs");
    }
    bytes32[] memory expectedL1ToL2Msgs = _populateInbox();
    for (uint256 i = 0; i < l1ToL2Msgs.length; i++) {
      assertEq(l1ToL2Msgs[i], expectedL1ToL2Msgs[i], "Invalid l1ToL2Msgs");
    }
  }

  function testComputeKernelLogsIterationWithoutLogs() public {
    bytes memory kernelLogsLength = hex"00000004"; // 4 bytes containing value 4
    bytes memory iterationLogsLength = hex"00000000"; // 4 empty bytes indicating that length of this iteration's logs is 0
    bytes memory encodedLogs = abi.encodePacked(kernelLogsLength, iterationLogsLength);

    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    bytes32 kernelPublicInputsLogsHash = bytes32(0);
    bytes32 privateCircuitPublicInputsLogsHash = sha256(new bytes(0));

    bytes32 referenceLogsHash =
      sha256(abi.encodePacked(kernelPublicInputsLogsHash, privateCircuitPublicInputsLogsHash));

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHash, "Incorrect logs hash");
  }

  function testComputeKernelLogs1Iteration() public {
    // || K_LOGS_LEN | I1_LOGS_LEN | I1_LOGS ||
    // K_LOGS_LEN = 4 + 8 = 12 (hex"0000000c")
    // I1_LOGS_LEN = 8 (hex"00000008")
    // I1_LOGS = 8 bytes (hex"0000000493e78a70") // Note: 00000004 is the length of 1 log within function logs
    bytes memory firstFunctionCallLogs = hex"0000000493e78a70";
    // Prefix logs with length of kernel logs (12) and length of iteration 1 logs (8)
    bytes memory encodedLogs = abi.encodePacked(hex"0000000c00000008", firstFunctionCallLogs);
    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    // Zero because this is the first iteration
    bytes32 previousKernelPublicInputsLogsHash = bytes32(0);
    bytes32 privateCircuitPublicInputsLogsHashFirstCall = sha256(firstFunctionCallLogs);

    bytes32 referenceLogsHash = sha256(
      abi.encodePacked(
        previousKernelPublicInputsLogsHash, privateCircuitPublicInputsLogsHashFirstCall
      )
    );

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHash, "Incorrect logs hash");
  }

  function testComputeKernelLogs2Iterations() public {
    // || K_LOGS_LEN | I1_LOGS_LEN | I1_LOGS | I2_LOGS_LEN | I2_LOGS ||
    // K_LOGS_LEN = 4 + 8 + 4 + 20 = 36 (hex"00000024")
    // I1_LOGS_LEN = 8 (hex"00000008")
    // I1_LOGS = 8 random bytes (hex"0000000493e78a70")
    // I2_LOGS_LEN = 20 (hex"00000014")
    // I2_LOGS = 20 bytes (hex"0000001006a86173c86c6d3f108eefc36e7fb014")
    bytes memory firstFunctionCallLogs = hex"0000000493e78a70";
    bytes memory secondFunctionCallLogs = hex"0000001006a86173c86c6d3f108eefc36e7fb014";
    bytes memory encodedLogs = abi.encodePacked(
      hex"0000002400000008", firstFunctionCallLogs, hex"00000014", secondFunctionCallLogs
    );
    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    bytes32 referenceLogsHashFromIteration1 =
      sha256(abi.encodePacked(bytes32(0), sha256(firstFunctionCallLogs)));

    bytes32 privateCircuitPublicInputsLogsHashSecondCall = sha256(secondFunctionCallLogs);

    bytes32 referenceLogsHashFromIteration2 = sha256(
      abi.encodePacked(
        referenceLogsHashFromIteration1, privateCircuitPublicInputsLogsHashSecondCall
      )
    );

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHashFromIteration2, "Incorrect logs hash");
  }

  function testComputeKernelLogsMiddleIterationWithoutLogs() public {
    // || K_LOGS_LEN | I1_LOGS_LEN | I1_LOGS | I2_LOGS_LEN | I2_LOGS | I3_LOGS_LEN | I3_LOGS ||
    // K_LOGS_LEN = 4 + 8 + 4 + 0 + 4 + 20 = 40 (hex"00000028")
    // I1_LOGS_LEN = 8 (hex"00000008")
    // I1_LOGS = 8 random bytes (hex"0000000493e78a70")
    // I2_LOGS_LEN = 0 (hex"00000000")
    // I2_LOGS = 0 bytes (hex"")
    // I3_LOGS_LEN = 20 (hex"00000014")
    // I3_LOGS = 20 random bytes (hex"0000001006a86173c86c6d3f108eefc36e7fb014")
    bytes memory firstFunctionCallLogs = hex"0000000493e78a70";
    bytes memory secondFunctionCallLogs = hex"";
    bytes memory thirdFunctionCallLogs = hex"0000001006a86173c86c6d3f108eefc36e7fb014";
    bytes memory encodedLogs = abi.encodePacked(
      hex"0000002800000008",
      firstFunctionCallLogs,
      hex"00000000",
      secondFunctionCallLogs,
      hex"00000014",
      thirdFunctionCallLogs
    );
    (bytes32 logsHash, uint256 bytesAdvanced) = helper.computeKernelLogsHash(encodedLogs);

    bytes32 referenceLogsHashFromIteration1 =
      sha256(abi.encodePacked(bytes32(0), sha256(firstFunctionCallLogs)));

    bytes32 privateCircuitPublicInputsLogsHashSecondCall = sha256(secondFunctionCallLogs);

    bytes32 referenceLogsHashFromIteration2 = sha256(
      abi.encodePacked(
        referenceLogsHashFromIteration1, privateCircuitPublicInputsLogsHashSecondCall
      )
    );

    bytes32 privateCircuitPublicInputsLogsHashThirdCall = sha256(thirdFunctionCallLogs);

    bytes32 referenceLogsHashFromIteration3 = sha256(
      abi.encodePacked(referenceLogsHashFromIteration2, privateCircuitPublicInputsLogsHashThirdCall)
    );

    assertEq(bytesAdvanced, encodedLogs.length, "Advanced by an incorrect number of bytes");
    assertEq(logsHash, referenceLogsHashFromIteration3, "Incorrect logs hash");
  }

  function _populateInbox() internal returns (bytes32[] memory) {
    address sender = 0x9965507D1a55bcC2695C58ba16FB37d819B0A4dc;
    bytes32 recipient = 0x1647b194c649f5dd01d7c832f89b0f496043c9150797923ea89e93d5ac619a93;
    bytes32[] memory messages = new bytes32[](16);
    for (uint256 i = 0; i < 16; i++) {
      bytes32 content = bytes32(uint256(0x401 + i));
      uint32 deadline = type(uint32).max;

      vm.prank(sender);
      bytes32 temp = inbox.sendL2Message(
        DataStructures.L2Actor({actor: recipient, version: 1}), deadline, content, bytes32(0)
      );
      messages[i] = temp;
    }
    return messages;
  }
}
