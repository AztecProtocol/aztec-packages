VERSION 0.8

deps:
  LOCALLY
  LET bb_source_hash = $(cd .. && git ls-tree -r HEAD | grep 'barretenberg/cpp' | awk '{print $3}' | git hash-object --stdin)

  FROM ../build-images+from-registry
  COPY ../noir/+nargo/nargo /usr/bin/nargo
  COPY ../barretenberg/cpp/+preset-release/bin/bb /usr/src/barretenberg/cpp/build/bin/bb
  RUN --secret AWS_ACCESS_KEY_ID --secret AWS_SECRET_ACCESS_KEY mkdir -p ~/.aws && \
      bash -c 'echo -e "[default]\naws_access_key_id=$AWS_ACCESS_KEY_ID\naws_secret_access_key=$AWS_SECRET_ACCESS_KEY" > ~/.aws/credentials'
  ENV BB_HASH=$bb_source_hash
  ENV NARGO=nargo

source:
  FROM +deps
  WORKDIR /usr/src/noir-projects

  COPY package.json yarn.lock .
  RUN yarn

  COPY client_ivc_circuits.json .
  COPY --dir aztec-nr noir-contracts noir-protocol-circuits mock-protocol-circuits scripts .

build-contracts:
  ARG RAYON_NUM_THREADS

  FROM +source
  ENV RAYON_NUM_THREADS=$RAYON_NUM_THREADS

  # Install transpiler
  COPY ../avm-transpiler/+build/avm-transpiler /usr/bin/avm-transpiler
  ENV TRANSPILER=avm-transpiler

  WORKDIR /usr/src/noir-projects/noir-contracts
  DO ../build-system/s3-cache-scripts/+WITH_CACHE \
    --prefix="noir-projects-noir-contracts" \
    --rebuild_patterns="../../noir/.rebuild_patterns_native ../../avm-transpiler/.rebuild_patterns ../../barretenberg/cpp/.rebuild_patterns .rebuild_patterns" \
    --command="./bootstrap.sh" \
    --build_artifacts="target"

  WORKDIR /usr/src/noir-projects
  SAVE ARTIFACT noir-contracts

build-protocol-circuits:
  ARG RAYON_NUM_THREADS
  LOCALLY
  FROM +source

  ENV RAYON_NUM_THREADS=$RAYON_NUM_THREADS
  ENV PARALLEL_VK=false

  WORKDIR /usr/src/noir-projects/noir-protocol-circuits

  DO ../build-system/s3-cache-scripts/+WITH_CACHE \
    --prefix="noir-projects-noir-protocol-circuits" \
    --rebuild_patterns="../../noir/.rebuild_patterns_native ../../barretenberg/cpp/.rebuild_patterns .rebuild_patterns" \
    --command="./bootstrap.sh" \
    --build_artifacts="target Nargo.toml private_kernel_reset_dimensions.json crates/autogenerated"

  WORKDIR /usr/src/noir-projects
  SAVE ARTIFACT noir-protocol-circuits

build-mock-protocol-circuits:
  ARG RAYON_NUM_THREADS
  LOCALLY
  FROM +source

  ENV RAYON_NUM_THREADS=$RAYON_NUM_THREADS
  ENV PARALLEL_VK=false

  WORKDIR /usr/src/noir-projects/mock-protocol-circuits
  DO ../build-system/s3-cache-scripts/+WITH_CACHE \
    --prefix="noir-projects-mock-protocol-circuits" \
    --rebuild_patterns="../../noir/.rebuild_patterns_native ../../barretenberg/cpp/.rebuild_patterns .rebuild_patterns" \
    --command="./bootstrap.sh" \
    --build_artifacts="target"

  WORKDIR /usr/src/noir-projects
  SAVE ARTIFACT mock-protocol-circuits

build:
  FROM +source
  BUILD +build-contracts
  BUILD +build-protocol-circuits
  BUILD +build-mock-protocol-circuits

  COPY +build-contracts/noir-contracts ./noir-contracts
  COPY +build-protocol-circuits/noir-protocol-circuits ./noir-protocol-circuits
  COPY +build-mock-protocol-circuits/mock-protocol-circuits ./mock-protocol-circuits

  SAVE ARTIFACT aztec-nr
  SAVE ARTIFACT noir-contracts
  SAVE ARTIFACT noir-protocol-circuits
  SAVE ARTIFACT mock-protocol-circuits

test:
  BUILD +test-protocol-circuits
  BUILD +test-aztec-nr
  BUILD +test-contracts

test-protocol-circuits:
  FROM +build

  # Install nargo
  COPY ../noir/+nargo/nargo /usr/bin/nargo

  RUN cd /usr/src/noir-projects/noir-protocol-circuits && nargo test --silence-warnings --skip-brillig-constraints-check

test-aztec-nr:
  FROM ../yarn-project/+txe

  # Install nargo
  COPY ../noir/+nargo/nargo /usr/bin/nargo

  COPY +build/. /usr/src/noir-projects

  RUN cd /usr/src/yarn-project/txe && yarn start & \
      # Wait for TXE to initialize
      sleep 5 && \
      cd /usr/src/noir-projects/aztec-nr && \
      NARGO_FOREIGN_CALL_TIMEOUT=300000 nargo test --silence-warnings --oracle-resolver http://localhost:8080

test-contracts:
  FROM ../yarn-project/+txe

  # Install nargo
  COPY ../noir/+nargo/nargo /usr/bin/nargo

  COPY +build/. /usr/src/noir-projects

  RUN cd /usr/src/yarn-project/txe && yarn start & \
      # Wait for TXE to initialize
      sleep 5 && \
      cd /usr/src/noir-projects/noir-contracts && \
      # We need to increase the timeout since all tests running in parallel hammer TXE at the same time and processing slows down, leading to timeouts
      # The only way we currently have to batch tests is via RAYON_NUM_THREADS, which is not ideal
      NARGO_FOREIGN_CALL_TIMEOUT=300000 nargo test --silence-warnings --oracle-resolver http://localhost:8080

format:
  FROM +source

  WORKDIR /usr/src/noir-projects/noir-protocol-circuits
  RUN node ./scripts/generate_variants.js
  RUN nargo fmt --check

  WORKDIR /usr/src/noir-projects/mock-protocol-circuits
  RUN nargo fmt --check

  WORKDIR /usr/src/noir-projects/noir-contracts
  RUN nargo fmt --check

  WORKDIR /usr/src/noir-projects/aztec-nr
  RUN nargo fmt --check

gates-report:
  FROM +source
  WORKDIR /usr/src/noir-projects

  # Install bb
  COPY ../barretenberg/cpp/+preset-release/bin/bb /usr/src/barretenberg/cpp/build/bin/bb
  ENV BB_BIN /usr/src/barretenberg/cpp/build/bin/bb

  RUN cd noir-protocol-circuits && yarn && node ./scripts/generate_variants.js tiny && nargo compile --silence-warnings --skip-brillig-constraints-check

  COPY ./gates_report.sh ./gates_report.sh
  RUN ./gates_report.sh

  SAVE ARTIFACT ./noir-protocol-circuits/gates_report.json gates_report.json

public-functions-report:
  FROM +build-contracts
  WORKDIR /usr/src/noir-projects

  RUN cd noir-contracts && node publicFunctionsSizeReport.js ./target/

  SAVE ARTIFACT ./noir-contracts/public_functions_report.json public_functions_report.json

