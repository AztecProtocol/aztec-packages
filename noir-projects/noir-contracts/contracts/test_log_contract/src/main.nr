contract TestLog {
    use dep::aztec::prelude::PrivateSet;
    use dep::aztec::protocol_types::{
        traits::Serialize, grumpkin_point::GrumpkinPoint, grumpkin_private_key::GrumpkinPrivateKey,
        abis::function_selector::FunctionSelector
    };
    use dep::value_note::value_note::ValueNote;
    use dep::aztec::encrypted_logs::incoming_body::EncryptedLogIncomingBody;
    use dep::aztec::event::event_interface::EventInterface;

    #[aztec(event)]
    struct ExampleEvent0 {
        value0: Field,
        value1: Field,
    }

    // This should be autogenerated by the macros
    global EXAMPLE_EVENT_0_BYTES_LEN = 32 * 2 + 32 + 32;

    impl EventInterface<EXAMPLE_EVENT_0_BYTES_LEN> for ExampleEvent0 {
        fn _selector(self) -> FunctionSelector {
            FunctionSelector::from_signature("TestEvent(Field,Field,Field)")
        }

        fn to_be_bytes(self, randomness: Field) -> [u8; EXAMPLE_EVENT_0_BYTES_LEN] {
            let mut buffer: [u8; EXAMPLE_EVENT_0_BYTES_LEN] = [0; EXAMPLE_EVENT_0_BYTES_LEN];

            let randomness_bytes = randomness.to_be_bytes(32);
            let event_type_id_bytes = self._selector().to_field().to_be_bytes(32);

            for i in 0..32 {
                buffer[i] = randomness_bytes[i];
                buffer[32 + i] = event_type_id_bytes[i];
            }

            let serialized_event = self.serialize();

            for i in 0..serialized_event.len() {
                let bytes = serialized_event[i].to_be_bytes(32);
                for j in 0..32 {
                    buffer[64 + i * 32 + j] = bytes[j];
                }
            }

            buffer
        }
    }

    #[aztec(event)]
    struct ExampleEvent1 {
        value2: Field,
        value3: Field,
    }

    impl Serialize<2> for ExampleEvent0 {
        fn serialize(self) -> [Field; 2] {
            [self.value0, self.value1]
        }
    }

    impl Serialize<2> for ExampleEvent1 {
        fn serialize(self) -> [Field; 2] {
            [self.value2, self.value3]
        }
    }

    #[aztec(storage)]
    struct Storage {
        example_set: PrivateSet<ValueNote>,
    }

    // EXAMPLE_EVENT_0_BYTES_LEN + 16
    global EXAMPLE_EVENT_0_CIPHERTEXT_BYTES_LEN = 144;

    #[aztec(private)]
    fn compute_incoming_log_body_ciphertext(
        secret: GrumpkinPrivateKey,
        point: GrumpkinPoint,
        randomness: Field,
        event_type_id: Field,
        preimage: [Field; 2]
    ) -> [u8; EXAMPLE_EVENT_0_CIPHERTEXT_BYTES_LEN] {
        EncryptedLogIncomingBody::from_event(
            ExampleEvent0 { value0: preimage[0], value1: preimage[1] },
            randomness
        ).compute_ciphertext(secret, point).as_array()
    }

    #[aztec(private)]
    fn emit_encrypted_log(randomness: Field, event_type_id: Field, preimage: [Field; 6]) {
        let header = context.get_header();
        let msg_sender_ivpk_m = header.get_ivpk_m(&mut context, context.msg_sender());
        let msg_sender_ovpk_m = header.get_ovpk_m(&mut context, context.msg_sender());

        context.encrypt_and_emit_event(
            randomness,
            event_type_id,
            msg_sender_ovpk_m,
            msg_sender_ivpk_m,
            preimage
        );
    }

    #[aztec(private)]
    fn emit_encrypted_events(randomness: [Field; 2], preimages: [Field; 4]) {
        let header = context.get_header();
        let msg_sender_ivpk_m = header.get_ivpk_m(&mut context, context.msg_sender());
        let msg_sender_ovpk_m = header.get_ovpk_m(&mut context, context.msg_sender());

        context.encrypt_and_emit_event(
            randomness[0],
            ExampleEvent0::selector().to_field(),
            msg_sender_ovpk_m,
            msg_sender_ivpk_m,
            ExampleEvent0 { value0: preimages[0], value1: preimages[1] }.serialize()
        );

        context.encrypt_and_emit_event(
            randomness[1],
            ExampleEvent1::selector().to_field(),
            msg_sender_ovpk_m,
            msg_sender_ivpk_m,
            ExampleEvent1 { value2: preimages[2], value3: preimages[3] }.serialize()
        );
    }
}
