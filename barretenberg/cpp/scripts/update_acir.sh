#!/bin/bash
source $(git rev-parse --show-toplevel)/ci3/source

# This script replaces std::array<T, N> with std::shared_ptr<std::array<T, N>>
# to fix a memory issue caused by the code generated by https://github.com/zefchain/serde-reflection
# It does not properly translate Box<StaticArray> into a shared_ptr<StaticArray> causing large enums.
# Why shared_ptr and not unique_ptr? Simply as this compiles with a simple regex, and unique_ptr has deeper implications.

file=../src/barretenberg/dsl/acir_format/serde/acir.hpp
for file in ../src/barretenberg/dsl/acir_format/*.hpp; do
  perl -pi -e '
    s{std::array<\s*([^,<>]+?)\s*,\s*([0-9]+)\s*>}{std::shared_ptr<std::array<$1, $2>>}gx' "$file"
done
