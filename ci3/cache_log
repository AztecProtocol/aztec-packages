#!/bin/bash
# Runs the given command.
# If a redis cache is available, duplicate input into a cache log.
NO_CD=1 source $(git rev-parse --show-toplevel)/ci3/source
source $ci3/source_redis

name=$1

key=${2:-$(uuid)}
outfile=/tmp/$key
trap 'rm -f $outfile' EXIT
touch $outfile

function publish_log {
  cat $outfile | redis_setexz $key $CI_REDIS_EXPIRE
}

function live_publish_log {
  while [ -f $outfile ]; do
    if [ $(( $(date +%s) - $(stat -c %Y "$outfile") )) -le 5 ]; then
      publish_log
    fi
    sleep 5
  done
}

if [ "$CI_REDIS_AVAILABLE" -eq 1 ]; then
  log_str="$name log id: ${yellow}http://ci.aztec-labs.com/$key${reset}"
  echo_stderr -e "$log_str"
  live_publish_log &
  tee $outfile
  publish_log
  echo_stderr -e "$log_str"
elif [ "${NO_CAT:-0}" != 0 ]; then
  cat
fi
