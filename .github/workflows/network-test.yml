name: Aztec Network Test

on:
  workflow_dispatch:
    inputs:
      cluster:
        description: The cluster to deploy to, e.g. aztec-gke-private
        required: true
        default: "aztec-gke-private"
      namespace:
        description: The namespace to deploy to, e.g. smoke
        required: true
      test:
        description: The test to run, e.g. spartan/smoke.test.ts
        required: true

jobs:
  network_test:
    runs-on: ubuntu-latest

    env:
      NAMESPACE: ${{ inputs.namespace }}
      TEST: ${{ inputs.test }}
      CLUSTER_NAME: ${{ inputs.cluster }}
      REGION: us-west1-a
      PROJECT_ID: testnet-440309
      GKE_CLUSTER_CONTEXT: "gke_testnet-440309_us-west1-a_${{ inputs.cluster }}"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: gke-gcloud-auth-plugin

      - name: Install GKE Auth Plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Configure kubectl with GKE cluster
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} --region ${{ env.REGION }}

      - name: Run test
        run: |


          gcloud config set project ${{ env.PROJECT_ID }}

          ./spartan/tests/upgrade.sh ${{ env.NAMESPACE }}
