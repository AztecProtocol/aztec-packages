# Runs the entire new CI mode.
name: Run CI with Earthly
on:
  push:
    branches:
      - master
  pull_request:
jobs:
  ci-x86:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: "true"
          fetch-depth: 0
      - name: setup
        run: |
          mkdir -p ~/.ssh
          echo ${{ secrets.BUILD_INSTANCE_KEY }} | base64 -d > ~/.ssh/build_instance_key
          chmod 600 ~/.ssh/build_instance_key
          cat > ~/.ssh/config <<EOF
            IdentityFile ~/.ssh/build_instance_key
            StrictHostKeyChecking no
            User ubuntu

            Host build-instance-x86
              HostName build-instance-x86.aztecprotocol.com
              User ubuntu
              ControlMaster auto
              ControlPath ~/.ssh/%r@%h-%p
              ControlPersist 600

            Host build-instance-arm
              HostName build-instance-arm.aztecprotocol.com
              User ubuntu
              ControlMaster auto
              ControlPath ~/.ssh/%r@%h-%p
              ControlPersist 600
          EOF
      - name: ci
        run: DOCKER_HOST=build-instance-x86 INTERACTIVE=true TERM=xterm scripts/earthly

  ci-arm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: "true"
          fetch-depth: 0
      - name: setup
        run: |
          mkdir -p ~/.ssh
          echo ${{ secrets.BUILD_INSTANCE_KEY }} | base64 -d > ~/.ssh/build_instance_key
          chmod 600 ~/.ssh/build_instance_key
          cat > ~/.ssh/config <<EOF
            IdentityFile ~/.ssh/build_instance_key
            StrictHostKeyChecking no
            User ubuntu

            Host build-instance-x86
              HostName build-instance-x86.aztecprotocol.com
              User ubuntu
              ControlMaster auto
              ControlPath ~/.ssh/%r@%h-%p
              ControlPersist 600

            Host build-instance-arm
              HostName build-instance-arm.aztecprotocol.com
              User ubuntu
              ControlMaster auto
              ControlPath ~/.ssh/%r@%h-%p
              ControlPersist 600
          EOF
      - name: ci
        run: DOCKER_HOST=build-instance-arm INTERACTIVE=true TERM=xterm scripts/earthly
