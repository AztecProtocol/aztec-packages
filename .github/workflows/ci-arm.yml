name: CI (ARM)
on:
  push:
    branches: [ad/reenable-arm-ci] # [master]
  workflow_dispatch:
    inputs: {}
concurrency:
  # force parallelism in master, cancelling in branches (only relevant to workflow_dispatch)
  group: ci-${{ github.ref_name == 'master' && github.run_id || github.ref_name }}
  cancel-in-progress: true
jobs:
  setup:
    uses: ./.github/workflows/setup-runner.yml
    with:
      username: master
      runner_type: builder-arm
    secrets: inherit

  # all the end-to-end integration tests for aztec
  e2e:
    needs: setup
    runs-on: master-arm
    steps:
      - uses: actions/checkout@v4,
        with: { ref: "${{ github.event.pull_request.head.sha }}" }
      - uses: ./.github/ci-setup-action
        with:
          concurrency_key: e2e-master-arm-e2e-tests
      - name: Test
        working-directory: ./yarn-project/end-to-end/
        timeout-minutes: 40
        run: earthly-ci -P --no-output +uniswap-trade-on-l1-from-l2

  notify:
    needs: [e2e]
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/master' && failure() }}
    steps:
      - name: Send notification to aztec3-ci channel if workflow failed on master
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: |
            {
              "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NOTIFY_WORKFLOW_TRIGGER_URL }}
