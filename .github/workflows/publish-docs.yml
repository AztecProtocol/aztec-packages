name: Publish Docs
on:
  workflow_dispatch:
    inputs:
      tag:
        description: The tag to build from.
        required: true

jobs:
  setup:
    uses: ./.github/workflows/setup-runner.yml
    with:
      username: master
      runner_type: builder-x86
    secrets: inherit

  publish:
    needs: setup
    runs-on: master-x86
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag || env.GITHUB_REF }}
      - uses: ./.github/ci-setup-action
        with:
          dockerhub_password: "${{ secrets.DOCKERHUB_PASSWORD }}"
          concurrency_key: docs-preview-${{ inputs.username || github.actor }}-x86

      - timeout-minutes: 25
        run: earthly-ci --no-output ./docs/+deploy-prod --NETLIFY_AUTH_TOKEN=${{ secrets.NETLIFY_AUTH_TOKEN }} --NETLIFY_SITE_ID=${{ secrets.NETLIFY_SITE_ID }}

  pdf:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: generate pdf
        run: npx docusaurus-prince-pdf -u http://docs.aztec.network/protocol-specs/intro --dest ./docs/pdf -o protocol-specs
        timeout-minutes: 4
