name: Auto Merge to Train Branches

on:
  push:
    branches:
      - next

jobs:
  merge-to-train:
    name: Merge next to ${{ matrix.train-branch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        train-branch:
          - merge-train/barretenberg
          - merge-train/docs
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0
          token: ${{ secrets.AZTEC_BOT_GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name AztecBot
          git config --global user.email tech@aztecprotocol.com

      - name: Find active merge queue PR
        id: find-pr
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          github-token: ${{ secrets.AZTEC_BOT_GITHUB_TOKEN }}
          script: |
            const trainBranch = '${{ matrix.train-branch }}';
            
            // Find open PRs targeting this merge-train branch
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: trainBranch,
              state: 'open'
            });
            
            // Find the merge queue PR
            const queuePR = pulls.find(pr => 
              pr.title.includes('🚂 Merge Queue for')
            );
            
            if (queuePR) {
              core.setOutput('pr_branch', queuePR.head.ref);
              core.setOutput('pr_found', 'true');
              console.log(`Found merge queue PR #${queuePR.number} with branch ${queuePR.head.ref}`);
            } else {
              core.setOutput('pr_found', 'false');
              console.log(`No active merge queue PR found for ${trainBranch}`);
            }

      - name: Checkout and merge
        if: steps.find-pr.outputs.pr_found == 'true'
        id: merge
        run: |
          PR_BRANCH="${{ steps.find-pr.outputs.pr_branch }}"
          
          # Checkout the PR branch
          git fetch origin $PR_BRANCH
          git checkout $PR_BRANCH
          
          # Attempt to merge next
          if git merge origin/next --no-edit -m "Merge branch 'next' into $PR_BRANCH"; then
            echo "merge_success=true" >> $GITHUB_OUTPUT
            git push origin $PR_BRANCH
          else
            echo "merge_success=false" >> $GITHUB_OUTPUT
            echo "conflict_details<<EOF" >> $GITHUB_OUTPUT
            git diff --name-only --diff-filter=U >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Comment on conflict
        if: steps.find-pr.outputs.pr_found == 'true' && steps.merge.outputs.merge_success == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          github-token: ${{ secrets.AZTEC_BOT_GITHUB_TOKEN }}
          script: |
            const conflictFiles = `${{ steps.merge.outputs.conflict_details }}`;
            const trainBranch = '${{ matrix.train-branch }}';
            const comment = `## ⚠️ Auto-merge to ${trainBranch} failed
            
            Merge conflicts detected when merging \`next\` into \`${trainBranch}\`.
            
            **Conflicted files:**
            \`\`\`
            ${conflictFiles}
            \`\`\`
            
            Please resolve the conflicts manually.`;
            
            // Find the most recent commit on next
            const { data: commits } = await github.rest.repos.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: 'next',
              per_page: 1
            });
            
            if (commits.length > 0) {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: commits[0].sha,
                body: comment
              });
            }
