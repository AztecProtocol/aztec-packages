name: Nightly masternet deploy

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  get-latest-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      commit: ${{ steps.get_commit.outputs.COMMIT }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get latest published commit
        id: get_commit
        run: |
          COMMIT=$(curl -sL --retry 3 https://registry.hub.docker.com/v2/repositories/aztecprotocol/aztec/tags/master | jq -r ".digest")
          if [ -z "$COMMIT" ]; then
            echo "Failed to fetch commit hash"
            exit 1
          fi
          echo "COMMIT=$COMMIT" >> $GITHUB_OUTPUT

  deploy-network:
    needs: get-latest-commit
    uses: ./.github/workflows/network-deploy.yml
    if: needs.get-latest-commit.result == 'success'
    with:
      ref: master
      namespace: masternet
      values_file: rc-1.yaml
      aztec_docker_image: aztecprotocol/aztec@${{ needs.get-latest-commit.outputs.commit }}
      deployment_mnemonic_secret_name: testnet-deployment-mnemonic
      respect_tf_lock: "false"
      run_terraform_destroy: "true"
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
