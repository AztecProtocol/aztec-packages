name: Merge-Train Create PR

on:
  push:
    branches:
      - 'merge-train/*'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      
      - name: Check if PR exists and create if needed
        env:
          GITHUB_TOKEN: ${{ secrets.AZTEC_BOT_GITHUB_TOKEN }}
        run: |
          branch="${{ github.ref_name }}"
          
          # Check if PR already exists for this branch
          existing_pr=$(gh pr list --state open --head "$branch" --json number --jq '.[0].number // empty')
          
          if [[ -z "$existing_pr" ]]; then
            echo "No PR exists for $branch, creating one"
            
            # Determine base branch (default to next)
            base_branch="next"
            
            # Create PR with ci-no-squash label
            gh pr create --base "$base_branch" --head "$branch" \
              --title "feat: $branch" \
              --body "$(echo -e "See [merge-train-readme.md](https://github.com/${{ github.repository }}/blob/next/.github/workflows/merge-train-readme.md).\nThis is a merge-train.")" \
              --label "ci-no-squash"
            
            echo "Created PR for $branch"
          else
            echo "PR #$existing_pr already exists for $branch"
          fi