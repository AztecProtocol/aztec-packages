name: Deploy Scenario Network

on:
  workflow_call:
    inputs:
      cluster:
        description: The cluster to deploy to, e.g. aztec-gke-private or kind
        required: true
        type: string
      namespace:
        description: The namespace to deploy to
        required: true
        type: string
      ref:
        description: The branch name to deploy from
        required: true
        type: string
        default: "next"
      aztec_docker_image:
        description: The Docker image to use for the Aztec contracts
        required: true
        type: string
        default: "aztecprotocol/aztec:8ebe8d7c45190b002c77e29358f2b307a23b5336"
      devnet_mnemonic:
        description: The mnemonic to use for the devnet
        required: true
        type: string
        default: "test test test test test test test test test test test junk"
      rollup_deployment_mnemonic:
        description: The mnemonic to use for the rollup deployment
        required: true
        type: string
        default: "test test test test test test test test test test test junk"
    secrets:
      GCP_SA_KEY:
        description: The JSON key for the GCP service account
        required: true
      KUBECONFIG_B64:
        description: The base64 encoded kubeconfig
        required: true

  workflow_dispatch:
    inputs:
      cluster:
        description: The cluster to deploy to, e.g. aztec-gke-private or kind
        required: true
        type: string
        default: "kind"
      namespace:
        description: The namespace to deploy to
        required: true
        type: string
        default: "eth-devnet"
      ref:
        description: The branch name to deploy from.
        required: true
        type: string
        default: "next"
      aztec_docker_image:
        description: The Docker image to use for the Aztec contracts
        required: true
        type: string
        default: "aztecprotocol/aztec:8ebe8d7c45190b002c77e29358f2b307a23b5336"
      devnet_mnemonic:
        description: The mnemonic to use for the devnet
        required: true
        type: string
        default: "test test test test test test test test test test test junk"
      rollup_deployment_mnemonic:
        description: The mnemonic to use for the rollup deployment
        required: true
        type: string
        default: "test test test test test test test test test test test junk"

jobs:
  # First job: Deploy the Eth Devnet
  scenario_dispatch_deploy_eth_devnet:
    uses: ./.github/workflows/deploy-eth-devnet.yml
    with:
      cluster: ${{ inputs.cluster }}
      namespace: ${{ inputs.namespace }}
      ref: ${{ inputs.ref }}
      # Prefilled values for scenario network
      chain_id: 1337
      block_time: 4 # Faster block time for scenario testing
      gas_limit: "32000000" # Higher gas limit for complex scenarios
      resource_profile: ${{ inputs.cluster == 'kind' && 'dev' || 'prod' }}
      create_static_ips: ${{ inputs.cluster == 'kind' && 'false' || 'true' }}
      run_terraform_destroy: "false"
      mnemonic: ${{ inputs.devnet_mnemonic }}
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

  scenario_dispatch_deploy_rollup_contracts:
    needs: scenario_dispatch_deploy_eth_devnet
    uses: ./.github/workflows/deploy-rollup-contracts.yml
    with:
      cluster: ${{ inputs.cluster }}
      namespace: ${{ inputs.namespace }}
      ref: ${{ inputs.ref }}
      l1_rpc_urls: ${{ needs.scenario_dispatch_deploy_eth_devnet.outputs.rpc_url }}
      l1_chain_id: ${{ needs.scenario_dispatch_deploy_eth_devnet.outputs.chain_id }}
      aztec_docker_image: ${{ inputs.aztec_docker_image }}
      mnemonic: ${{ inputs.rollup_deployment_mnemonic }}
      salt: "456"
      # indices 1,2,3,4 on the junk mnemonic
      validators: "0x70997970C51812dc3A010C7d01b50e0d17dc79C8,0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC,0x90F79bf6EB2c4f870365E785982E1f101E93b906,0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65"
      sponsored_fpc: true
      real_verifier: true
      # Aztec environment variables
      aztec_slot_duration: 12
      aztec_epoch_duration: 32
      aztec_target_committee_size: 4
      aztec_proof_submission_epochs: 1
      aztec_activation_threshold: 100
      aztec_ejection_threshold: 50
      aztec_slashing_quorum: 6
      aztec_slashing_round_size: 10
      aztec_governance_proposer_quorum: 6
      aztec_governance_proposer_round_size: 10
      aztec_mana_target: 1000000
      aztec_proving_cost_per_mana: 100
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

  deploy_scenario_network:
    needs: scenario_dispatch_deploy_rollup_contracts
    runs-on: ubuntu-latest
    env:
      TF_STATE_BUCKET: aztec-terraform
      REGION: us-west1-a
      # Common Terraform variables as environment variables
      TF_VAR_NAMESPACE: ${{ inputs.namespace || 'eth-devnet' }}

    steps:
      - name: Deploy scenario network
        run: |
          echo "Deployed scenario network!"
