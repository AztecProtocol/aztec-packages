name: Deploy Scenario Network

on:
  workflow_call:
    inputs:
      cluster:
        description: The cluster to deploy to, e.g. aztec-gke-private or kind
        required: true
        type: string
      namespace:
        description: The namespace to deploy to
        required: true
        type: string
      ref:
        description: The branch name to deploy from
        required: true
        type: string
        default: "next"
      aztec_docker_image:
        description: The Docker image to use for the Aztec contracts
        required: true
        type: string
        default: "aztecprotocol/aztec:2.0.0-nightly.20250821"
      devnet_mnemonic:
        description: The mnemonic to use for the devnet
        required: true
        type: string
        default: "test test test test test test test test test test test junk"

      rollup_deployment_mnemonic:
        description: The mnemonic to use for the rollup deployment
        required: true
        type: string
        default: "test test test test test test test test test test test junk"
    secrets:
      GCP_SA_KEY:
        description: The JSON key for the GCP service account
        required: true
      KUBECONFIG_B64:
        description: The base64 encoded kubeconfig
        required: true

  workflow_dispatch:
    inputs:
      cluster:
        description: The cluster to deploy to, e.g. aztec-gke-private or kind
        required: true
        type: string
        default: "kind"
      namespace:
        description: The namespace to deploy to
        required: true
        type: string
        default: "eth-devnet"
      ref:
        description: The branch name to deploy from.
        required: true
        type: string
        default: "next"
      aztec_docker_image:
        description: The Docker image to use for the Aztec contracts
        required: true
        type: string
        default: "aztecprotocol/aztec:2.0.0-nightly.20250821"
      devnet_mnemonic:
        description: The mnemonic to use for the devnet
        required: true
        type: string
        default: "test test test test test test test test test test test junk"

      rollup_deployment_mnemonic:
        description: The mnemonic to use for the rollup deployment
        required: true
        type: string
        default: "test test test test test test test test test test test junk"

jobs:
  # First job: Deploy the Eth Devnet
  scenario_dispatch_deploy_eth_devnet:
    uses: ./.github/workflows/deploy-eth-devnet.yml
    with:
      cluster: ${{ inputs.cluster }}
      namespace: ${{ inputs.namespace }}
      ref: ${{ inputs.ref }}
      # Prefilled values for scenario network
      chain_id: 1337
      block_time: 12
      gas_limit: "32000000"
      resource_profile: ${{ inputs.cluster == 'kind' && 'dev' || 'prod' }}
      create_static_ips: false
      run_terraform_destroy: false
      mnemonic: ${{ inputs.devnet_mnemonic }}
      prefunded_mnemonic_indices: "0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,1000,1001,1002,1003"
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

  scenario_dispatch_deploy_rollup_contracts:
    needs: scenario_dispatch_deploy_eth_devnet
    uses: ./.github/workflows/deploy-rollup-contracts.yml
    with:
      cluster: ${{ inputs.cluster }}
      namespace: ${{ inputs.namespace }}
      ref: ${{ inputs.ref }}
      l1_rpc_urls: ${{ needs.scenario_dispatch_deploy_eth_devnet.outputs.rpc_url }}
      l1_chain_id: ${{ needs.scenario_dispatch_deploy_eth_devnet.outputs.chain_id }}
      aztec_docker_image: ${{ inputs.aztec_docker_image }}
      mnemonic: ${{ inputs.rollup_deployment_mnemonic }}
      salt: "456"
      # indices 1,2,3,4 on the junk mnemonic
      validators: "0x70997970C51812dc3A010C7d01b50e0d17dc79C8,0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC,0x90F79bf6EB2c4f870365E785982E1f101E93b906,0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65"
      sponsored_fpc: true
      real_verifier: true
      # Aztec environment variables
      aztec_slot_duration: 36
      aztec_epoch_duration: 32
      aztec_target_committee_size: 4
      aztec_proof_submission_epochs: 1
      aztec_activation_threshold: 100
      aztec_ejection_threshold: 50
      aztec_slashing_quorum: 6
      aztec_slashing_round_size: 10
      aztec_governance_proposer_quorum: 6
      aztec_governance_proposer_round_size: 10
      aztec_mana_target: 1000000
      aztec_proving_cost_per_mana: 100
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

  scenario_dispatch_deploy_aztec_infra:
    needs:
      - scenario_dispatch_deploy_rollup_contracts
      - scenario_dispatch_deploy_eth_devnet
    uses: ./.github/workflows/deploy-aztec-infra.yml
    with:
      cluster: ${{ inputs.cluster }}
      namespace: ${{ inputs.namespace }}
      ref: ${{ inputs.ref }}
      aztec_docker_image: ${{ inputs.aztec_docker_image }}
      l1_rpc_urls: '["${{ needs.scenario_dispatch_deploy_eth_devnet.outputs.rpc_url }}"]'
      l1_consensus_host_urls: '["${{ needs.scenario_dispatch_deploy_eth_devnet.outputs.beacon_url }}"]'
      l1_consensus_host_api_keys: '[""]'
      l1_consensus_host_api_key_headers: '[""]'
      l1_chain_id: ${{ needs.scenario_dispatch_deploy_eth_devnet.outputs.chain_id }}
      registry_address: ${{ needs.scenario_dispatch_deploy_rollup_contracts.outputs.registry_address }}
      slash_factory_address: ${{ needs.scenario_dispatch_deploy_rollup_contracts.outputs.slash_factory_address }}
      fee_asset_handler_address: ${{ needs.scenario_dispatch_deploy_rollup_contracts.outputs.fee_asset_handler_address }}
      validator_mnemonic: ${{ inputs.rollup_deployment_mnemonic }}
      validator_mnemonic_start_index: 1
      validators_per_node: 1
      validator_replicas: 4
      prover_mnemonic: ${{ inputs.rollup_deployment_mnemonic }}
      prover_mnemonic_start_index: 1000
      p2p_bootstrap_resource_profile: ${{ inputs.cluster == 'kind' && 'dev' || 'prod' }}
      validator_resource_profile: ${{ inputs.cluster == 'kind' && 'dev' || 'prod' }}
      prover_resource_profile: ${{ inputs.cluster == 'kind' && 'dev' || 'prod' }}
      rpc_resource_profile: ${{ inputs.cluster == 'kind' && 'dev' || 'prod' }}
      rpc_external_ingress: false
      run_terraform_destroy: false
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
      KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

  deploy_scenario_network:
    needs: scenario_dispatch_deploy_aztec_infra
    runs-on: ubuntu-latest
    env:
      TF_STATE_BUCKET: aztec-terraform
      REGION: us-west1-a
      # Common Terraform variables as environment variables
      TF_VAR_NAMESPACE: ${{ inputs.namespace || 'eth-devnet' }}

    steps:
      - name: Deploy scenario network
        run: |
          echo "Deployed scenario network!"
