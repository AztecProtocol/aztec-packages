# Reusable setup workflow for CI tasks
name: Setup Workflow
description: 'Reusable setup steps'

inputs:
  dockerhub_password:
    required: true
    description: 'DockerHub Password'
  github_actor:
    required: true
    description: 'GitHub Actor'
  git_ref:
    required: true
    description: 'Pull Request SHA'

runs:
  # define an action, runs in OS of caller
  using: composite
  steps:
    - uses: earthly/actions-setup@v1
      with:
        version: 'v0.8.5'

    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.git_ref }}
        submodules: false # we cache submodules

    - name: Cache Submodules
      uses: actions/cache@v2
      with:
        path: |
          l1-contracts/lib/openzeppelin-contracts
          l1-contracts/lib/forge-std
          barretenberg/sol/lib/forge-std
          barretenberg/sol/lib/solidity-stringutils
          barretenberg/sol/lib/openzeppelin-contracts
        key: submodules-${{ hashFiles('.gitmodules') }}

    - name: Checkout Submodules
      if: steps.cache-submodules.outputs.cache-hit != 'true'
      run: git submodule sync --recursive && git submodule update --init --recursive

    - name: Setup
      working-directory: ./scripts
      run: ./scripts/setup_env.sh ${{ inputs.dockerhub_password }} ${{ inputs.github_actor }}
