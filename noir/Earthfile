VERSION 0.8

nargo-src:

    FROM ../build-images/+build
    WORKDIR /usr/src
    # Relevant source (TODO finer-grained 'tooling')
    COPY --dir \
      noir-repo/acvm-repo \
      noir-repo/aztec_macros \
      noir-repo/compiler \
      noir-repo/noir_stdlib \
      noir-repo/tooling \
      noir-repo/test_programs \
      noir-repo/utils \
      noir-repo/Cargo.lock \
      noir-repo/Cargo.toml \
      noir-repo/.github \
      noir-repo

    # Fetch any dependencies so that they can be cached
    RUN cd noir-repo && cargo fetch && cd ../

    # NOTE: we use a fake commit hash here
    # we don't want Noir to rebuild everytime the parent repo changes
    # just only when it changes
    # the commit hash gets injected into version strings
    ENV COMMIT_HASH=$(find . -type f -exec sha256sum {} ';' | sort | sha256sum | awk '{print $1}')
    RUN echo $COMMIT_HASH > .content-hash

    # # borrow Nix's approach to build everything in 1970
    ENV SOURCE_TIMESTAMP=1
    ENV SOURCE_DATE_EPOCH=1

nargo:
    FROM +nargo-src
    RUN ./noir-repo/.github/scripts/wasm-bindgen-install.sh
    COPY ./scripts/bootstrap_native.sh ./scripts/bootstrap_native.sh
    RUN ./scripts/bootstrap_native.sh
    SAVE ARTIFACT /usr/src/noir-repo/target/release/nargo nargo
    SAVE ARTIFACT /usr/src/noir-repo/target/release/acvm acvm
    SAVE IMAGE aztecprotocol/nargo

test:
  FROM +nargo
  COPY ./scripts/test_native.sh ./scripts/test_native.sh
  COPY noir-repo/.rustfmt.toml noir-repo/.rustfmt.toml
  RUN ./scripts/test_native.sh

examples:
  FROM +nargo
  ENV PATH="/usr/src/noir-repo/target/release:${PATH}"

  COPY --dir noir-repo/examples noir-repo
  COPY ../barretenberg/cpp/+preset-clang-assert/bin/bb /usr/src/barretenberg/cpp/build/bin/bb

  ENV BACKEND=/usr/src/barretenberg/cpp/build/bin/bb

  WORKDIR noir-repo/examples/codegen-verifier
  RUN ./test.sh

  WORKDIR ../prove_and_verify
  RUN ./test.sh

format:
  FROM +nargo
  ENV PATH=$PATH:/usr/src/noir-repo/target/release

  COPY ./noir-repo/test_programs ./noir-repo/test_programs
  COPY ./noir-repo/noir_stdlib ./noir-repo/noir_stdlib

  WORKDIR ./noir-repo/test_programs
  RUN ./format.sh check

  WORKDIR ../noir_stdlib
  RUN nargo fmt --check

packages-deps:
    BUILD ../barretenberg/ts/+build # prefetch

    LOCALLY
    LET packages = $(git ls-files "**/package*.json" package*.json)
    LET tsconfigs = $(git ls-files "**/tsconfig*.json" tsconfig*.json)

    FROM +nargo-src

    COPY ../barretenberg/ts/+build/build /usr/src/barretenberg/ts

    WORKDIR /usr/src/noir

    COPY --dir \
      ./noir-repo/package.json \
      ./noir-repo/yarn.lock \
      ./noir-repo/.yarnrc.yml \
      ./noir-repo/.yarn \
      ./noir-repo

    FOR file IN $packages
        COPY $file $file
    END

    RUN cd noir-repo && yarn install --immutable && cd ../

    FOR file IN $tsconfigs
      COPY $file $file
    END

    # Relevant source (TODO finer-grained)
    COPY --dir \
      noir-repo/acvm-repo \
      noir-repo/aztec_macros \
      noir-repo/compiler \
      noir-repo/docs \
      noir-repo/noir_stdlib \
      noir-repo/scripts \
      noir-repo/test_programs \
      noir-repo/tooling \
      noir-repo/utils \
      noir-repo/Cargo.lock \
      noir-repo/.yarnrc.yml \
      noir-repo/.yarn \
      noir-repo/yarn.lock \
      noir-repo/package.json \
      noir-repo/LICENSE* \
      noir-repo/*.toml \
      noir-repo/*.json \
      noir-repo/*.js \
      noir-repo/.github \
      noir-repo

packages:
    FROM +packages-deps

    COPY ./scripts/bootstrap_packages.sh ./scripts/bootstrap_packages.sh
    RUN ./scripts/bootstrap_packages.sh
    SAVE ARTIFACT packages
    SAVE IMAGE --cache-hint

packages-test-build:
    FROM +packages-deps

    COPY +nargo/nargo /usr/src/noir/noir-repo/target/release/nargo
    COPY +nargo/acvm /usr/src/noir/noir-repo/target/release/acvm

    ENV NARGO_BACKEND_PATH=/usr/src/barretenberg/ts/dest/node/main.js
    ENV PATH=$PATH:/usr/src/noir/noir-repo/target/release

    WORKDIR /usr/src/barretenberg/ts
    RUN yarn --immutable

    WORKDIR /usr/src/noir/noir-repo
    COPY --dir noir-repo/.github/scripts/wasm-bindgen-install.sh ./.github/scripts/wasm-bindgen-install.sh
    RUN ./.github/scripts/wasm-bindgen-install.sh

    ENV SOURCE_DATE_EPOCH=$(date +%s)
    ENV GIT_DIRTY=false
    ENV GIT_COMMIT=$COMMIT_HASH
    RUN yarn build
    # this builds text fixtures to be used in tests
    RUN yarn workspace @noir-lang/noir_wasm run test:build_fixtures

    SAVE ARTIFACT /usr/src /usr/src

packages-test-node:
    FROM +packages-test-build
    ENV NODE_OPTIONS=--max_old_space_size=8192
    WORKDIR /usr/src/noir/noir-repo
    RUN yarn workspaces foreach \
      --parallel \
      --verbose \
      --exclude @noir-lang/root \ # foreach includes the root workspace, ignore it
      --exclude @noir-lang/noir_js \ # noir_js OOMs
      --exclude integration-tests \ # separate node and browser tests
      --exclude @noir-lang/noir_wasm \
      run test
    RUN yarn workspaces foreach \
      --parallel \
      --verbose \
      --include integration-tests \
      --include @noir-lang/noir_wasm \
      run test:node

packages-test-browser:
    FROM node:18
    COPY --dir +packages-test-build/usr/src /usr
    WORKDIR /usr/src/noir/noir-repo
    RUN ./.github/scripts/playwright-install.sh
    RUN yarn workspaces foreach \
      --verbose \
      --include integration-tests \
      --include @noir-lang/noir_wasm \
      run test:browser

packages-test:
    BUILD +packages-test-node
    BUILD +packages-test-browser

run:
    # When running the container, mount the users home directory to same location.
    FROM ubuntu:noble
    # Install Tini as nargo doesn't handle signals properly.
    # Install git as nargo needs it to clone.
    RUN apt-get update && apt-get install -y git tini && rm -rf /var/lib/apt/lists/* && apt-get clean
    COPY +build/. /usr/src
    ENTRYPOINT ["/usr/bin/tini", "--", "/usr/src/nargo"]

build-acir-tests:
    LOCALLY
    # Prepare our exact dependency formula, this avoids problems with copied empty folders or build artifacts
    RUN rm -rf .earthly-staging && mkdir -p .earthly-staging
    RUN cp --parents $(git ls-files "noir-repo/test_programs/*.toml" "noir-repo/test_programs/*.nr" "noir-repo/test_programs/rebuild.sh") .earthly-staging
    FROM ../build-images/+build
    COPY +nargo/ /usr/src/noir-repo/target/release
    ENV PATH="/usr/src/noir-repo/target/release:${PATH}"
    WORKDIR /usr/src/noir-repo/test_programs
    COPY .earthly-staging/noir-repo/test_programs /usr/src/noir-repo/test_programs/
    RUN /usr/src/noir-repo/target/release/nargo --version
    # TODO(#6225): We have trouble with concurrency and pass 'true' to build in serial, see #6225 for details
    RUN ./rebuild.sh true
    SAVE ARTIFACT /usr/src/noir-repo/test_programs/acir_artifacts/*

barretenberg-acir-benches-bb:
  FROM ubuntu:noble
  RUN apt update && \
      apt install -y curl git jq unzip
  COPY ../barretenberg/cpp/+preset-clang-assert/bin/bb /usr/src/barretenberg/cpp/build/bin/bb
  COPY ../barretenberg/+acir-tests/ /usr/src/barretenberg/acir_tests
  COPY +build-acir-tests/ /usr/src/acir_artifacts

  ENV TEST_SRC=/usr/src/acir_artifacts

  WORKDIR /usr/src/barretenberg/acir_tests

export-bench-acir-bb:
  ARG EARTHLY_GIT_HASH
  FROM +barretenberg-acir-benches-bb
  SAVE IMAGE aztecprotocol/barretenberg-acir-benches:$EARTHLY_GIT_HASH
 
bench-publish-acir-bb:
  ARG PULL_REQUEST
  ARG BRANCH
  ARG COMMIT_HASH
  LOCALLY
  
  # Let docker compose know about the pushed tags above
  ENV AZTEC_DOCKER_TAG=$(git rev-parse HEAD)
  # Optimize to not cause serial behavior if image already exists
  IF ! docker image ls --format '{{.Repository}}:{{.Tag}}' | grep "aztecprotocol/barretenberg-acir-benches:$AZTEC_DOCKER_TAG"
    WAIT
      BUILD +export-bench-acir-bb
    END
  END

  RUN mkdir -p ./log
  RUN docker run -v "$(pwd)/log":/log -e LOG_FILE=/log/bench-acir.jsonl --rm aztecprotocol/barretenberg-acir-benches:$AZTEC_DOCKER_TAG ./bench_acir_tests.sh sha256

  DO ../+UPLOAD_LOGS --PULL_REQUEST=$PULL_REQUEST --BRANCH=$BRANCH --COMMIT_HASH=$COMMIT_HASH

barretenberg-acir-tests-bb:
    FROM ../build-images/+build

    COPY ../barretenberg/cpp/+preset-clang-assert/bin/bb /usr/src/barretenberg/cpp/build/bin/bb
    COPY ../barretenberg/+acir-tests/ /usr/src/barretenberg/acir_tests
    COPY +build-acir-tests/ /usr/src/acir_artifacts

    WORKDIR /usr/src/barretenberg/acir_tests
    RUN rm -rf ./acir_tests

    ENV TEST_SRC /usr/src/acir_artifacts
    ENV VERBOSE=1
    # Run every acir test through native bb build prove_then_verify flow for UltraPlonk.
    # This ensures we test independent pk construction through real/garbage witness data paths.
    RUN FLOW=prove_then_verify ./run_acir_tests.sh
    # Construct and separately verify a UltraHonk proof for a single program
    RUN FLOW=prove_then_verify_ultra_honk ./run_acir_tests.sh double_verify_nested_proof
    # Construct and separately verify a GoblinUltraHonk proof for all acir programs
    RUN FLOW=prove_then_verify_goblin_ultra_honk ./run_acir_tests.sh
    # Construct and verify a UltraHonk proof for a single program
    RUN FLOW=prove_and_verify_ultra_honk ./run_acir_tests.sh double_verify_nested_proof
    # Construct and verify a Goblin UltraHonk (GUH) proof for a single arbitrary program
    RUN FLOW=prove_and_verify_goblin_ultra_honk ./run_acir_tests.sh 6_array
    # Construct and verify a UltraHonk proof for all ACIR programs using the new witness stack workflow
    RUN FLOW=prove_and_verify_ultra_honk_program ./run_acir_tests.sh
    # This is a "full" Goblin flow. It constructs and verifies four proofs: GoblinUltraHonk, ECCVM, Translator, and merge
    RUN FLOW=prove_and_verify_goblin ./run_acir_tests.sh 6_array
    # Run 1_mul through native bb build, all_cmds flow, to test all cli args.
    RUN FLOW=all_cmds ./run_acir_tests.sh 1_mul

barretenberg-acir-tests-sol:
    FROM ../build-images/+build

    COPY ../barretenberg/cpp/+preset-sol/ /usr/src/barretenberg/cpp/build
    COPY ../barretenberg/cpp/+preset-clang-assert/bin/bb /usr/src/barretenberg/cpp/build/bin/bb
    COPY ../barretenberg/+acir-tests/ /usr/src/barretenberg/acir_tests
    COPY ../barretenberg/+sol/ /usr/src/barretenberg/sol
    COPY +build-acir-tests/ /usr/src/acir_artifacts

    WORKDIR /usr/src/barretenberg/acir_tests

    ENV TEST_SRC /usr/src/acir_artifacts
    ENV VERBOSE=1

    RUN (cd sol-test && yarn)
    RUN PARALLEL=1 FLOW=sol ./run_acir_tests.sh assert_statement double_verify_proof double_verify_nested_proof

barretenberg-acir-tests-bb.js:
    # Playwright not supported on base image ubuntu:noble, results in unmet dependencies
    FROM node:18.19.0
    RUN apt update && apt install -y curl jq lsof

    COPY ../barretenberg/ts/+build/build/ /usr/src/barretenberg/ts
    COPY ../barretenberg/+acir-tests/ /usr/src/barretenberg/acir_tests
    COPY +build-acir-tests/ /usr/src/acir_artifacts

    WORKDIR /usr/src/barretenberg/acir_tests

    # Build/install ts apps.
    RUN cd browser-test-app && yarn && yarn build
    RUN cd headless-test && yarn && npx playwright install && npx playwright install-deps
    RUN cd ../ts && yarn
    ENV VERBOSE=1
    ENV TEST_SRC /usr/src/acir_artifacts

    # Run double_verify_proof through bb.js on node to check 512k support.
    RUN BIN=../ts/dest/node/main.js FLOW=prove_then_verify ./run_acir_tests.sh double_verify_proof
    # Run a single arbitrary test not involving recursion through bb.js for UltraHonk
    RUN BIN=../ts/dest/node/main.js FLOW=prove_and_verify_ultra_honk ./run_acir_tests.sh 6_array
    # Run a single arbitrary test not involving recursion through bb.js for GoblinUltraHonk
    RUN BIN=../ts/dest/node/main.js FLOW=prove_and_verify_goblin_ultra_honk ./run_acir_tests.sh 6_array
    # Run a single arbitrary test not involving recursion through bb.js for full Goblin
    RUN BIN=../ts/dest/node/main.js FLOW=prove_and_verify_goblin ./run_acir_tests.sh 6_array
    # Run 1_mul through bb.js build, all_cmds flow, to test all cli args.
    RUN BIN=../ts/dest/node/main.js FLOW=all_cmds ./run_acir_tests.sh 1_mul
    # Run double_verify_proof through bb.js on chrome testing multi-threaded browser support.
    # TODO: Currently headless webkit doesn't seem to have shared memory so skipping multi-threaded test.
    RUN BROWSER=chrome THREAD_MODEL=mt ./run_acir_tests_browser.sh double_verify_proof
    # Run 1_mul through bb.js on chrome/webkit testing single threaded browser support.
    RUN BROWSER=chrome THREAD_MODEL=st ./run_acir_tests_browser.sh 1_mul
    # Commenting for now as fails intermittently. Unreproducable on mainframe.
    # See https://github.com/AztecProtocol/aztec-packages/issues/2104
    #RUN BROWSER=webkit THREAD_MODEL=st ./run_acir_tests_browser.sh 1_mul
