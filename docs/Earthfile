VERSION 0.8

FROM node:18.19.0
WORKDIR /usr/src/docs

deps:
  COPY ./yarn.lock ./yarn.lock
  COPY ./package.json ./package.json
  RUN yarn install --frozen-lockfile

build:
  BUILD ../yarn-project/+build-dev
  BUILD ../+release-meta
  FROM +deps

  RUN apt update && apt install -y jq curl perl && rm -rf /var/lib/apt/lists/* && apt-get clean

  COPY --dir ../yarn-project/+build-dev/usr/src /usr
  COPY ../+release-meta/usr/src/.release-please-manifest.json /usr/src

  COPY . .

  RUN ./scripts/build.sh
  SAVE ARTIFACT build

serve:
  FROM +deps
  COPY +build/build build
  COPY ./static static
  COPY ./src src
  COPY ./docusaurus.config.js .
  COPY ./sidebars.js .
  ENTRYPOINT ["yarn", "serve"]
  EXPOSE 3000
  SAVE IMAGE aztecprotocol/docs-server


