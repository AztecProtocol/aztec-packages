#!/usr/bin/env bash
set -euo pipefail

CALLED_FROM=$PWD

function run_with_compose {
  # Favour 'docker compose', falling back on docker-compose.
  CMD="docker compose"
  $CMD &>/dev/null || CMD="docker-compose"
  ARGS=$1

  # Function to be executed when SIGINT is received.
  cleanup() {
    $CMD $ARGS down
  }

  # Set trap to catch SIGINT and call the cleanup function.
  trap cleanup SIGINT

  # Change working dir, so relative volume mounts are in the right place.
  cd $(dirname $0)/..

  WORKING_DIR=${CALLED_FROM} NARGO_CMD="${3:-}" AZTEC_CMD=$2 $CMD $ARGS -f $HOME/.aztec/docker-compose.yml up --force-recreate --remove-orphans --abort-on-container-exit
}

if [ $# == 2 ] && [ "$1" == "start" ] && [ "$2" == "--sandbox" ]; then
  run_with_compose "-p sandbox --profile sandbox" "start --sandbox"
elif [ "$1" == "test" ]; then
  TEST_ARGS="$@ --silence-warnings --use-legacy --oracle-resolver=http://aztec:8081"
  run_with_compose "-p aztec-test --profile test" "test" "$TEST_ARGS"
else 
  $(dirname $0)/.aztec-run aztecprotocol/aztec "$@"
fi
