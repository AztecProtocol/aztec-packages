# Kernel Circuits

Kernel circuits are used to validate the correctness of a private or public transaction, manage call stacks and implement traditional call semantics.

There are 3 Kernel circuits:
- private kernel circuit
- public kernel circuit
- contract deployment kernel circuit 

Private kernel circuit proofs are generated by the client (transaction sender). Public & Contract Deployment kernel circuit proofs are generated by the rollup provider.

The Kernel circuits act recursively upon their respective callstack. The private kernel circuit will pop 1 item off the private callstack, verify a proof of correctness, extract additional calls to be made from the verified proof and insert them into their respective call stacks. In addition the previous kernel circuit proof (if present) is aggregated with the private transaction proof.

This process is repeated recursively until the private callstack is empty. This final proof is then fed into a public kernel circuit, which performs the same action on the public callstack.

If any of the private / public circuits _deploy_ a contract as part of their execution, then the contract deployment callstack will be nonempty, and so the final public kernel snark will be fed into the contract deployment kernel circuit, which will recurse through its callstack.

A transaction is ready to be [rolled up](../rollup-circuits/rollup-circuits.md)) at the point that a public kernel circuit proof is generated whose private and public call stacks are empty.


## Achieving arbitrary recursion

A circuit cannot verify a proof of itself if the verification key is required as part of the circuit's structure.

We can solve this by having the kernel circuit verify a prior kernel proof using a *user-input* verification key. i.e. the Private Kernel Snark verification key is *also* a public input into the circuit (or at least a hash of it).

The kernel circuit must then perform a consistency check; that the key present in the previous kernel proof's public inputs is equal to the key present in the current public inputs.

Finally, the circuit in the next phase of the transaction process (the public kernel circuit) must verify that the key from the private kernel proof's public inputs is equal to the canonical private kernel circuit verification key.

Repeat this for the public kernel circuit, (and again for the contract deployment circuit, if applicable), where this time the rollup circuit will check the correctness of the used key.

The current spec also allows for multiple 'sizes' of kernel circuit - i.e. kernel circuits with various numbers of public inputs, to save on proof generation times.